最近再看阿里千问的技术报告：[https://github.com/QwenLM/Qwen-7B/blob/main/tech_memo.md](https://link.zhihu.com/?target=https%3A//github.com/QwenLM/Qwen-7B/blob/main/tech_memo.md)，发现qianwen模型的位置编码部分使用的是untied embedding，我对这部分不太熟悉，所以找来论文研究一下。

在摘要中，论文指出了现有的绝对位置编码存在以下一些问题：

1. **混合的相关性：** 绝对位置编码采用加法操作将位置嵌入（positional embeddings）与词嵌入（word embeddings）相加。这个操作在位置信息和词义信息之间引入了混合的相关性，使得在[注意力机制](https://www.zhihu.com/search?q=%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A3196023627%7D)中出现了混合和噪声的关联。这可能导致模型的表达能力受到限制。
2. **随机性：** 由于混合相关性的存在，绝对位置编码可能引入不必要的随机性。在模型中，这种随机性可能表现为无法稳定地捕捉到单词位置与其含义之间的准确关系。这种随机性可能对模型的性能产生负面影响。

### 论文中讨论了特殊符号[CLS]在BERT模型中的角色。为什么[CLS]在句子中具有特殊的重要性？它在下游任务中的角色是什么？

论文中提到的特殊符号[CLS]在BERT模型中具有特殊的重要性，主要有两个方面的原因：

1. **全局汇总信息：** [CLS] 符号的主要作用是充当整个句子的表示。在BERT和类似的预训练模型中，[CLS] 符号在经过预训练的编码之后，承载了整个句子的语义信息的综合汇总。这意味着[CLS] 的编码包含了句子中所有单词的信息，并且可以用于在下游任务中表示整个句子的语义信息。
2. **下游任务中的重要性：** 在下游自然语言处理任务中，例如文本分类、命名实体识别、句子对匹配等，通常需要对整个句子进行分析和判断。[CLS] 符号的编码可以被用作模型的输出，用于表示整个输入句子的语义特征。这个[CLS] 编码被认为是模型对整个输入句子进行理解和推理的重要依据。

  ![[Pasted image 20240414145334.png]]
 
在Transformer with Untied Positional Encoding (TUPE)方法中，词汇和位置信息的关联是通过以下方式处理的：

**解耦词汇和位置的相关性：** TUPE的核心思想之一是将词汇信息和位置信息的相关性进行解耦。在传统的绝对位置编码中，位置嵌入（positional embeddings）与词嵌入（word embeddings）相加，然后传递给模型。这种操作会引入混合的相关性，因为不同的信息资源（词汇和位置）之间存在混合的关联。为了解决这个问题，TUPE使用不同的投影矩阵来分别处理词汇信息和位置信息。具体来说，使用了两个不同的投影矩阵UQ和UK来处理位置嵌入，从而使词汇和位置的相关性得以解耦。这可以通过以下公式表示：  
    - 对于绝对位置编码，位置嵌入的计算方式为：αijTUPE-A = reset(θ)(PUQ)(PUK)T。  
    - 对于相对位置编码，位置嵌入的计算方式为：αijTUPE-R = reset(θ)(P+UQ)(P+UK)T。  
    这样，使用不同的投影矩阵，词汇和位置之间的相关性被明确地分开处理，消除了混合的相关性。

**解耦[CLS]符号的位置关联：** 除了解耦词汇和位置的相关性，TUPE还提出了一种方法来解耦特殊符号[CLS]的位置关联。[CLS]符号通常用于捕捉整个句子的全局信息，其上下文表示在下游任务中用于句子级别的任务。然而，[CLS]符号与自然语言单词在句子中的位置有所不同，因此需要特殊处理。在TUPE中，[CLS]符号的位置关联被重置，以避免[CLS]符号受到其他位置的影响。这是通过修改位置关联矩阵的方式实现的，具体如下：
![[Pasted image 20240414145518.png]]
这个修改确保了[CLS]符号在注意力机制中不会受到来自其他位置的位置相关性的干扰。

通过这些方法，TUPE实现了对词汇和位置信息的解耦，以及对[CLS]符号的特殊处理，从而提高了位置编码的效率和性能。这些修改使模型更好地理解句子的结构和语境，并有助于在各种自然语言处理任务中提高性能。


