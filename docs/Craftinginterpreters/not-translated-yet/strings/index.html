<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Craftinginterpreters/not-translated-yet/strings" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">strings | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jabberwocky238.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jabberwocky238.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/strings"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="strings | My Site"><meta data-rh="true" name="description" content="&quot;Ah? A small aversion to menial labor?&quot; The doctor cocked an eyebrow."><meta data-rh="true" property="og:description" content="&quot;Ah? A small aversion to menial labor?&quot; The doctor cocked an eyebrow."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/strings"><link data-rh="true" rel="alternate" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/strings" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/strings" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.0d35426a.css">
<script src="/assets/js/runtime~main.0868a236.js" defer="defer"></script>
<script src="/assets/js/main.f1c02528.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jabberwocky238/jabberwocky238.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="展开侧边栏分类 &#x27;Tutorial - Basics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="展开侧边栏分类 &#x27;Tutorial - Extras&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/english">English</a><button aria-label="展开侧边栏分类 &#x27;English&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/crafting-interpreter">Crafting-interpreter</a><button aria-label="折叠侧边栏分类 &#x27;Crafting-interpreter&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/welcome">Welcome</a><button aria-label="展开侧边栏分类 &#x27;Welcome&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/not-translated-yet">not-translated-yet</a><button aria-label="折叠侧边栏分类 &#x27;not-translated-yet&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-bytecode-virtual-machine">a-bytecode-virtual-machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-tree-walk-interpreter">a-tree-walk-interpreter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-virtual-machine">a-virtual-machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/acknowledgements">acknowledgements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/appendix-i">appendix-i</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/appendix-ii">appendix-ii</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/backmatter">backmatter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/calls-and-functions">calls-and-functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/chunks-of-bytecode">chunks-of-bytecode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/classes-and-instances">classes-and-instances</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/classes">classes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/closures">closures</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/compiling-expressions">compiling-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/contents">contents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/control-flow">control-flow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/dedication">dedication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/evaluating-expressions">evaluating-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/functions">functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/garbage-collection">garbage-collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/global-variables">global-variables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/hash-tables">hash-tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/inheritance">inheritance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/jumping-back-and-forth">jumping-back-and-forth</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/local-variables">local-variables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/methods-and-initializers">methods-and-initializers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/optimization">optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/parsing-expressions">parsing-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/representing-code">representing-code</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/resolving-and-binding">resolving-and-binding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/scanning-on-demand">scanning-on-demand</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/scanning">scanning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/statements-and-state">statements-and-state</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/strings">strings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/superclasses">superclasses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/the-lox-language">the-lox-language</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/types-of-values">types-of-values</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/crafting-interpreter"><span itemprop="name">Crafting-interpreter</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/not-translated-yet"><span itemprop="name">not-translated-yet</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">strings</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>strings</h1></header><blockquote>
<p>&quot;Ah? A small aversion to menial labor?&quot; The doctor cocked an eyebrow.
&quot;Understandable, but misplaced. One should treasure those hum-drum
tasks that keep the body occupied but leave the mind and heart unfettered.&quot;</p>
<p><cite>Tad Williams, <em>The Dragonbone Chair</em></cite></p>
</blockquote>
<p>Our little VM can represent three types of values right now: numbers, Booleans,
and <code>nil</code>. Those types have two important things in common: they&#x27;re immutable
and they&#x27;re small. Numbers are the largest, and they still fit into two 64-bit
words. That&#x27;s a small enough price that we can afford to pay it for all values,
even Booleans and nils which don&#x27;t need that much space.</p>
<p>Strings, unfortunately, are not so petite. There&#x27;s no maximum length for a
string. Even if we were to artificially cap it at some contrived limit like
<span name="pascal">255</span> characters, that&#x27;s still too much memory to spend
on every single value.</p>
<aside name="pascal">
<p>UCSD Pascal, one of the first implementations of Pascal, had this exact limit.
Instead of using a terminating null byte to indicate the end of the string like
C, Pascal strings started with a length value. Since UCSD used only a single
byte to store the length, strings couldn&#x27;t be any longer than 255 characters.</p>
<img decoding="async" loading="lazy" src="image/strings/pstring.png" alt="The Pascal string &#x27;hello&#x27; with a length byte of 5 preceding it." class="img_ev3q">
</aside>
<p>We need a way to support values whose sizes vary, sometimes greatly. This is
exactly what dynamic allocation on the heap is designed for. We can allocate as
many bytes as we need. We get back a pointer that we&#x27;ll use to keep track of the
value as it flows through the VM.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="values-and-objects">Values and Objects<a href="#values-and-objects" class="hash-link" aria-label="Values and Objects的直接链接" title="Values and Objects的直接链接">​</a></h2>
<p>Using the heap for larger, variable-sized values and the stack for smaller,
atomic ones leads to a two-level representation. Every Lox value that you can
store in a variable or return from an expression will be a Value. For small,
fixed-size types like numbers, the payload is stored directly inside the Value
struct itself.</p>
<p>If the object is larger, its data lives on the heap. Then the Value&#x27;s payload is
a <em>pointer</em> to that blob of memory. We&#x27;ll eventually have a handful of
heap-allocated types in clox: strings, instances, functions, you get the idea.
Each type has its own unique data, but there is also state they all share that
<a href="/docs/Craftinginterpreters/not-translated-yet/garbage-collection.html">our future garbage collector</a> will use to manage their memory.</p>
<img decoding="async" loading="lazy" src="image/strings/value.png" class="wide img_ev3q" alt="Field layout of number and obj values.">
<p>We&#x27;ll call this common representation <span name="short">&quot;Obj&quot;</span>. Each Lox
value whose state lives on the heap is an Obj. We can thus use a single new
ValueType case to refer to all heap-allocated types.</p>
<aside name="short">
<p>&quot;Obj&quot; is short for &quot;object&quot;, natch.</p>
</aside>
<p>^code val-obj (1 before, 1 after)</p>
<p>When a Value&#x27;s type is <code>VAL_OBJ</code>, the payload is a pointer to the heap memory,
so we add another case to the union for that.</p>
<p>^code union-object (1 before, 1 after)</p>
<p>As we did with the other value types, we crank out a couple of helpful macros
for working with Obj values.</p>
<p>^code is-obj (1 before, 2 after)</p>
<p>This evaluates to <code>true</code> if the given Value is an Obj. If so, we can use this:</p>
<p>^code as-obj (2 before, 1 after)</p>
<p>It extracts the Obj pointer from the value. We can also go the other way.</p>
<p>^code obj-val (1 before, 2 after)</p>
<p>This takes a bare Obj pointer and wraps it in a full Value.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="struct-inheritance">Struct Inheritance<a href="#struct-inheritance" class="hash-link" aria-label="Struct Inheritance的直接链接" title="Struct Inheritance的直接链接">​</a></h2>
<p>Every heap-allocated value is an Obj, but <span name="objs">Objs</span> are
not all the same. For strings, we need the array of characters. When we get to
instances, they will need their data fields. A function object will need its
chunk of bytecode. How do we handle different payloads and sizes? We can&#x27;t use
another union like we did for Value since the sizes are all over the place.</p>
<aside name="objs">
<p>No, I don&#x27;t know how to pronounce &quot;objs&quot; either. Feels like there should be a
vowel in there somewhere.</p>
</aside>
<p>Instead, we&#x27;ll use another technique. It&#x27;s been around for ages, to the point
that the C specification carves out specific support for it, but I don&#x27;t know
that it has a canonical name. It&#x27;s an example of <a href="https://en.wikipedia.org/wiki/Type_punning" target="_blank" rel="noopener noreferrer"><em>type punning</em></a>, but that
term is too broad. In the absence of any better ideas, I&#x27;ll call it <strong>struct
inheritance</strong>, because it relies on structs and roughly follows how
single-inheritance of state works in object-oriented languages.</p>
<p>Like a tagged union, each Obj starts with a tag field that identifies what kind
of object it is -- string, instance, etc. Following that are the payload fields.
Instead of a union with cases for each type, each type is its own separate
struct. The tricky part is how to treat these structs uniformly since C has no
concept of inheritance or polymorphism. I&#x27;ll explain that soon, but first lets
get the preliminary stuff out of the way.</p>
<p>The name &quot;Obj&quot; itself refers to a struct that contains the state shared across
all object types. It&#x27;s sort of like the &quot;base class&quot; for objects. Because of
some cyclic dependencies between values and objects, we forward-declare it in
the &quot;value&quot; module.</p>
<p>^code forward-declare-obj (2 before, 1 after)</p>
<p>And the actual definition is in a new module.</p>
<p>^code object-h</p>
<p>Right now, it contains only the type tag. Shortly, we&#x27;ll add some other
bookkeeping information for memory management. The type enum is this:</p>
<p>^code obj-type (1 before, 2 after)</p>
<p>Obviously, that will be more useful in later chapters after we add more
heap-allocated types. Since we&#x27;ll be accessing these tag types frequently, it&#x27;s
worth making a little macro that extracts the object type tag from a given
Value.</p>
<p>^code obj-type-macro (1 before, 2 after)</p>
<p>That&#x27;s our foundation.</p>
<p>Now, let&#x27;s build strings on top of it. The payload for strings is defined in a
separate struct. Again, we need to forward-declare it.</p>
<p>^code forward-declare-obj-string (1 before, 2 after)</p>
<p>The definition lives alongside Obj.</p>
<p>^code obj-string (1 before, 2 after)</p>
<p>A string object contains an array of characters. Those are stored in a separate,
heap-allocated array so that we set aside only as much room as needed for each
string. We also store the number of bytes in the array. This isn&#x27;t strictly
necessary but lets us tell how much memory is allocated for the string without
walking the character array to find the null terminator.</p>
<p>Because ObjString is an Obj, it also needs the state all Objs share. It
accomplishes that by having its first field be an Obj. C specifies that struct
fields are arranged in memory in the order that they are declared. Also, when
you nest structs, the inner struct&#x27;s fields are expanded right in place. So the
memory for Obj and for ObjString looks like this:</p>
<img decoding="async" loading="lazy" src="image/strings/obj.png" alt="The memory layout for the fields in Obj and ObjString." class="img_ev3q">
<p>Note how the first bytes of ObjString exactly line up with Obj. This is not a
coincidence -- C <span name="spec">mandates</span> it. This is designed to
enable a clever pattern: You can take a pointer to a struct and safely convert
it to a pointer to its first field and back.</p>
<aside name="spec">
<p>The key part of the spec is:</p>
<blockquote>
<p>§ 6.7.2.1 13</p>
<p>Within a structure object, the non-bit-field members and the units in which
bit-fields reside have addresses that increase in the order in which they
are declared. A pointer to a structure object, suitably converted, points to
its initial member (or if that member is a bit-field, then to the unit in
which it resides), and vice versa. There may be unnamed padding within a
structure object, but not at its beginning.</p>
</blockquote>
</aside>
<p>Given an <code>ObjString*</code>, you can safely cast it to <code>Obj*</code> and then access the
<code>type</code> field from it. Every ObjString &quot;is&quot; an Obj in the OOP sense of &quot;is&quot;. When
we later add other object types, each struct will have an Obj as its first
field. Any code that wants to work with all objects can treat them as base
<code>Obj*</code> and ignore any other fields that may happen to follow.</p>
<p>You can go in the other direction too. Given an <code>Obj*</code>, you can &quot;downcast&quot; it to
an <code>ObjString*</code>. Of course, you need to ensure that the <code>Obj*</code> pointer you have
does point to the <code>obj</code> field of an actual ObjString. Otherwise, you are
unsafely reinterpreting random bits of memory. To detect that such a cast is
safe, we add another macro.</p>
<p>^code is-string (1 before, 2 after)</p>
<p>It takes a Value, not a raw <code>Obj*</code> because most code in the VM works with
Values. It relies on this inline function:</p>
<p>^code is-obj-type (2 before, 2 after)</p>
<p>Pop quiz: Why not just put the body of this function right in the macro? What&#x27;s
different about this one compared to the others? Right, it&#x27;s because the body
uses <code>value</code> twice. A macro is expanded by inserting the argument <em>expression</em>
every place the parameter name appears in the body. If a macro uses a parameter
more than once, that expression gets evaluated multiple times.</p>
<p>That&#x27;s bad if the expression has side effects. If we put the body of
<code>isObjType()</code> into the macro definition and then you did, say,</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">IS_STRING</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">POP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>then it would pop two values off the stack! Using a function fixes that.</p>
<p>As long as we ensure that we set the type tag correctly whenever we create an
Obj of some type, this macro will tell us when it&#x27;s safe to cast a value to a
specific object type. We can do that using these:</p>
<p>^code as-string (1 before, 2 after)</p>
<p>These two macros take a Value that is expected to contain a pointer to a valid
ObjString on the heap. The first one returns the <code>ObjString*</code> pointer. The
second one steps through that to return the character array itself, since that&#x27;s
often what we&#x27;ll end up needing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="strings">Strings<a href="#strings" class="hash-link" aria-label="Strings的直接链接" title="Strings的直接链接">​</a></h2>
<p>OK, our VM can now represent string values. It&#x27;s time to add strings to the
language itself. As usual, we begin in the front end. The lexer already
tokenizes string literals, so it&#x27;s the parser&#x27;s turn.</p>
<p>^code table-string (1 before, 1 after)</p>
<p>When the parser hits a string token, it calls this parse function:</p>
<p>^code parse-string</p>
<p>This takes the string&#x27;s characters <span name="escape">directly</span> from the
lexeme. The <code>+ 1</code> and <code>- 2</code> parts trim the leading and trailing quotation marks.
It then creates a string object, wraps it in a Value, and stuffs it into the
constant table.</p>
<aside name="escape">
<p>If Lox supported string escape sequences like <code>\n</code>, we&#x27;d translate those here.
Since it doesn&#x27;t, we can take the characters as they are.</p>
</aside>
<p>To create the string, we use <code>copyString()</code>, which is declared in <code>object.h</code>.</p>
<p>^code copy-string-h (2 before, 1 after)</p>
<p>The compiler module needs to include that.</p>
<p>^code compiler-include-object (2 before, 1 after)</p>
<p>Our &quot;object&quot; module gets an implementation file where we define the new
function.</p>
<p>^code object-c</p>
<p>First, we allocate a new array on the heap, just big enough for the string&#x27;s
characters and the trailing <span name="terminator">terminator</span>, using
this low-level macro that allocates an array with a given element type and
count:</p>
<p>^code allocate (2 before, 1 after)</p>
<p>Once we have the array, we copy over the characters from the lexeme and
terminate it.</p>
<aside name="terminator" class="bottom">
<p>We need to terminate the string ourselves because the lexeme points at a range
of characters inside the monolithic source string and isn&#x27;t terminated.</p>
<p>Since ObjString stores the length explicitly, we <em>could</em> leave the character
array unterminated, but slapping a terminator on the end costs us only a byte
and lets us pass the character array to C standard library functions that expect
a terminated string.</p>
</aside>
<p>You might wonder why the ObjString can&#x27;t just point back to the original
characters in the source string. Some ObjStrings will be created dynamically at
runtime as a result of string operations like concatenation. Those strings
obviously need to dynamically allocate memory for the characters, which means
the string needs to <em>free</em> that memory when it&#x27;s no longer needed.</p>
<p>If we had an ObjString for a string literal, and tried to free its character
array that pointed into the original source code string, bad things would
happen. So, for literals, we preemptively copy the characters over to the heap.
This way, every ObjString reliably owns its character array and can free it.</p>
<p>The real work of creating a string object happens in this function:</p>
<p>^code allocate-string (2 before)</p>
<p>It creates a new ObjString on the heap and then initializes its fields. It&#x27;s
sort of like a constructor in an OOP language. As such, it first calls the &quot;base
class&quot; constructor to initialize the Obj state, using a new macro.</p>
<p>^code allocate-obj (1 before, 2 after)</p>
<p><span name="factored">Like</span> the previous macro, this exists mainly to
avoid the need to redundantly cast a <code>void*</code> back to the desired type. The
actual functionality is here:</p>
<aside name="factored">
<p>I admit this chapter has a sea of helper functions and macros to wade through. I
try to keep the code nicely factored, but that leads to a scattering of tiny
functions. They will pay off when we reuse them later.</p>
</aside>
<p>^code allocate-object (2 before, 2 after)</p>
<p>It allocates an object of the given size on the heap. Note that the size is
<em>not</em> just the size of Obj itself. The caller passes in the number of bytes so
that there is room for the extra payload fields needed by the specific object
type being created.</p>
<p>Then it initializes the Obj state -- right now, that&#x27;s just the type tag. This
function returns to <code>allocateString()</code>, which finishes initializing the ObjString
fields. <span name="viola"><em>Voilà</em></span>, we can compile and execute string
literals.</p>
<aside name="viola">
<img decoding="async" loading="lazy" src="image/strings/viola.png" class="above img_ev3q" alt="A viola.">
<p>Don&#x27;t get &quot;voilà&quot; confused with &quot;viola&quot;. One means &quot;there it is&quot; and the other
is a string instrument, the middle child between a violin and a cello. Yes, I
did spend two hours drawing a viola just to mention that.</p>
</aside>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="operations-on-strings">Operations on Strings<a href="#operations-on-strings" class="hash-link" aria-label="Operations on Strings的直接链接" title="Operations on Strings的直接链接">​</a></h2>
<p>Our fancy strings are there, but they don&#x27;t do much of anything yet. A good
first step is to make the existing print code not barf on the new value type.</p>
<p>^code call-print-object (1 before, 1 after)</p>
<p>If the value is a heap-allocated object, it defers to a helper function over in
the &quot;object&quot; module.</p>
<p>^code print-object-h (1 before, 2 after)</p>
<p>The implementation looks like this:</p>
<p>^code print-object</p>
<p>We have only a single object type now, but this function will sprout additional
switch cases in later chapters. For string objects, it simply <span name="term-2">prints</span> the character array as a C string.</p>
<aside name="term-2">
<p>I told you terminating the string would come in handy.</p>
</aside>
<p>The equality operators also need to gracefully handle strings. Consider:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;string&quot; == &quot;string&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These are two separate string literals. The compiler will make two separate
calls to <code>copyString()</code>, create two distinct ObjString objects and store them as
two constants in the chunk. They are different objects in the heap. But our
users (and thus we) expect strings to have value equality. The above expression
should evaluate to <code>true</code>. That requires a little special support.</p>
<p>^code strings-equal (1 before, 1 after)</p>
<p>If the two values are both strings, then they are equal if their character
arrays contain the same characters, regardless of whether they are two separate
objects or the exact same one. This does mean that string equality is slower
than equality on other types since it has to walk the whole string. We&#x27;ll revise
that <a href="/docs/Craftinginterpreters/not-translated-yet/hash-tables.html">later</a>, but this gives us the right semantics for now.</p>
<p>Finally, in order to use <code>memcmp()</code> and the new stuff in the &quot;object&quot; module, we
need a couple of includes. Here:</p>
<p>^code value-include-string (1 before, 2 after)</p>
<p>And here:</p>
<p>^code value-include-object (2 before, 1 after)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="concatenation">Concatenation<a href="#concatenation" class="hash-link" aria-label="Concatenation的直接链接" title="Concatenation的直接链接">​</a></h3>
<p>Full-grown languages provide lots of operations for working with strings --
access to individual characters, the string&#x27;s length, changing case, splitting,
joining, searching, etc. When you implement your language, you&#x27;ll likely want
all that. But for this book, we keep things <em>very</em> minimal.</p>
<p>The only interesting operation we support on strings is <code>+</code>. If you use that
operator on two string objects, it produces a new string that&#x27;s a concatenation
of the two operands. Since Lox is dynamically typed, we can&#x27;t tell which
behavior is needed at compile time because we don&#x27;t know the types of the
operands until runtime. Thus, the <code>OP_ADD</code> instruction dynamically inspects the
operands and chooses the right operation.</p>
<p>^code add-strings (1 before, 1 after)</p>
<p>If both operands are strings, it concatenates. If they&#x27;re both numbers, it adds
them. Any other <span name="convert">combination</span> of operand types is a
runtime error.</p>
<aside name="convert" class="bottom">
<p>This is more conservative than most languages. In other languages, if one
operand is a string, the other can be any type and it will be implicitly
converted to a string before concatenating the two.</p>
<p>I think that&#x27;s a fine feature, but would require writing tedious &quot;convert to
string&quot; code for each type, so I left it out of Lox.</p>
</aside>
<p>To concatenate strings, we define a new function.</p>
<p>^code concatenate</p>
<p>It&#x27;s pretty verbose, as C code that works with strings tends to be. First, we
calculate the length of the result string based on the lengths of the operands.
We allocate a character array for the result and then copy the two halves in. As
always, we carefully ensure the string is terminated.</p>
<p>In order to call <code>memcpy()</code>, the VM needs an include.</p>
<p>^code vm-include-string (1 before, 2 after)</p>
<p>Finally, we produce an ObjString to contain those characters. This time we use a
new function, <code>takeString()</code>.</p>
<p>^code take-string-h (2 before, 1 after)</p>
<p>The implementation looks like this:</p>
<p>^code take-string</p>
<p>The previous <code>copyString()</code> function assumes it <em>cannot</em> take ownership of the
characters you pass in. Instead, it conservatively creates a copy of the
characters on the heap that the ObjString can own. That&#x27;s the right thing for
string literals where the passed-in characters are in the middle of the source
string.</p>
<p>But, for concatenation, we&#x27;ve already dynamically allocated a character array on
the heap. Making another copy of that would be redundant (and would mean
<code>concatenate()</code> has to remember to free its copy). Instead, this function claims
ownership of the string you give it.</p>
<p>As usual, stitching this functionality together requires a couple of includes.</p>
<p>^code vm-include-object-memory (1 before, 1 after)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="freeing-objects">Freeing Objects<a href="#freeing-objects" class="hash-link" aria-label="Freeing Objects的直接链接" title="Freeing Objects的直接链接">​</a></h2>
<p>Behold this innocuous-seeming expression:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;st&quot; + &quot;ri&quot; + &quot;ng&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the compiler chews through this, it allocates an ObjString for each of
those three string literals and stores them in the chunk&#x27;s constant table and
generates this <span name="stack">bytecode</span>:</p>
<aside name="stack">
<p>Here&#x27;s what the stack looks like after each instruction:</p>
<img decoding="async" loading="lazy" src="image/strings/stack.png" alt="The state of the stack at each instruction." class="img_ev3q">
</aside>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">0000    OP_CONSTANT         0 &quot;st&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0002    OP_CONSTANT         1 &quot;ri&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0004    OP_ADD</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0005    OP_CONSTANT         2 &quot;ng&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0007    OP_ADD</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0008    OP_RETURN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first two instructions push <code>&quot;st&quot;</code> and <code>&quot;ri&quot;</code> onto the stack. Then the
<code>OP_ADD</code> pops those and concatenates them. That dynamically allocates a new
<code>&quot;stri&quot;</code> string on the heap. The VM pushes that and then pushes the <code>&quot;ng&quot;</code>
constant. The last <code>OP_ADD</code> pops <code>&quot;stri&quot;</code> and <code>&quot;ng&quot;</code>, concatenates them, and
pushes the result: <code>&quot;string&quot;</code>. Great, that&#x27;s what we expect.</p>
<p>But, wait. What happened to that <code>&quot;stri&quot;</code> string? We dynamically allocated it,
then the VM discarded it after concatenating it with <code>&quot;ng&quot;</code>. We popped it from
the stack and no longer have a reference to it, but we never freed its memory.
We&#x27;ve got ourselves a classic memory leak.</p>
<p>Of course, it&#x27;s perfectly fine for the <em>Lox program</em> to forget about
intermediate strings and not worry about freeing them. Lox automatically manages
memory on the user&#x27;s behalf. The responsibility to manage memory doesn&#x27;t
<em>disappear</em>. Instead, it falls on our shoulders as VM implementers.</p>
<p>The full <span name="borrowed">solution</span> is a <a href="/docs/Craftinginterpreters/not-translated-yet/garbage-collection.html">garbage collector</a> that
reclaims unused memory while the program is running. We&#x27;ve got some other stuff
to get in place before we&#x27;re ready to tackle that project. Until then, we are
living on borrowed time. The longer we wait to add the collector, the harder it
is to do.</p>
<aside name="borrowed">
<p>I&#x27;ve seen a number of people implement large swathes of their language before
trying to start on the GC. For the kind of toy programs you typically run while
a language is being developed, you actually don&#x27;t run out of memory before
reaching the end of the program, so this gets you surprisingly far.</p>
<p>But that underestimates how <em>hard</em> it is to add a garbage collector later. The
collector <em>must</em> ensure it can find every bit of memory that <em>is</em> still being
used so that it doesn&#x27;t collect live data. There are hundreds of places a
language implementation can squirrel away a reference to some object. If you
don&#x27;t find all of them, you get nightmarish bugs.</p>
<p>I&#x27;ve seen language implementations die because it was too hard to get the GC in
later. If your language needs GC, get it working as soon as you can. It&#x27;s a
crosscutting concern that touches the entire codebase.</p>
</aside>
<p>Today, we should at least do the bare minimum: avoid <em>leaking</em> memory by making
sure the VM can still find every allocated object even if the Lox program itself
no longer references them. There are many sophisticated techniques that advanced
memory managers use to allocate and track memory for objects. We&#x27;re going to
take the simplest practical approach.</p>
<p>We&#x27;ll create a linked list that stores every Obj. The VM can traverse that
list to find every single object that has been allocated on the heap, whether or
not the user&#x27;s program or the VM&#x27;s stack still has a reference to it.</p>
<p>We could define a separate linked list node struct but then we&#x27;d have to
allocate those too. Instead, we&#x27;ll use an <strong>intrusive list</strong> -- the Obj struct
itself will be the linked list node. Each Obj gets a pointer to the next Obj in
the chain.</p>
<p>^code next-field (2 before, 1 after)</p>
<p>The VM stores a pointer to the head of the list.</p>
<p>^code objects-root (1 before, 1 after)</p>
<p>When we first initialize the VM, there are no allocated objects.</p>
<p>^code init-objects-root (1 before, 1 after)</p>
<p>Every time we allocate an Obj, we insert it in the list.</p>
<p>^code add-to-list (1 before, 1 after)</p>
<p>Since this is a singly linked list, the easiest place to insert it is as the
head. That way, we don&#x27;t need to also store a pointer to the tail and keep it
updated.</p>
<p>The &quot;object&quot; module is directly using the global <code>vm</code> variable from the &quot;vm&quot;
module, so we need to expose that externally.</p>
<p>^code extern-vm (2 before, 1 after)</p>
<p>Eventually, the garbage collector will free memory while the VM is still
running. But, even then, there will usually be unused objects still lingering in
memory when the user&#x27;s program completes. The VM should free those too.</p>
<p>There&#x27;s no sophisticated logic for that. Once the program is done, we can free
<em>every</em> object. We can and should implement that now.</p>
<p>^code call-free-objects (1 before, 1 after)</p>
<p>That empty function we defined <a href="/docs/Craftinginterpreters/not-translated-yet/a-virtual-machine.html#an-instruction-execution-machine">way back when</a> finally does something! It
calls this:</p>
<p>^code free-objects-h (1 before, 2 after)</p>
<p>Here&#x27;s how we free the objects:</p>
<p>^code free-objects</p>
<p>This is a CS 101 textbook implementation of walking a linked list and freeing
its nodes. For each node, we call:</p>
<p>^code free-object</p>
<p>We aren&#x27;t only freeing the Obj itself. Since some object types also allocate
other memory that they own, we also need a little type-specific code to handle
each object type&#x27;s special needs. Here, that means we free the character array
and then free the ObjString. Those both use one last memory management macro.</p>
<p>^code free (1 before, 2 after)</p>
<p>It&#x27;s a tiny <span name="free">wrapper</span> around <code>reallocate()</code> that
&quot;resizes&quot; an allocation down to zero bytes.</p>
<aside name="free">
<p>Using <code>reallocate()</code> to free memory might seem pointless. Why not just call
<code>free()</code>? Later, this will help the VM track how much memory is still being
used. If all allocation and freeing goes through <code>reallocate()</code>, it&#x27;s easy to
keep a running count of the number of bytes of allocated memory.</p>
</aside>
<p>As usual, we need an include to wire everything together.</p>
<p>^code memory-include-object (1 before, 2 after)</p>
<p>Then in the implementation file:</p>
<p>^code memory-include-vm (1 before, 2 after)</p>
<p>With this, our VM no longer leaks memory. Like a good C program, it cleans up
its mess before exiting. But it doesn&#x27;t free any objects while the VM is
running. Later, when it&#x27;s possible to write longer-running Lox programs, the VM
will eat more and more memory as it goes, not relinquishing a single byte until
the entire program is done.</p>
<p>We won&#x27;t address that until we&#x27;ve added <a href="/docs/Craftinginterpreters/not-translated-yet/garbage-collection.html">a real garbage collector</a>, but this
is a big step. We now have the infrastructure to support a variety of different
kinds of dynamically allocated objects. And we&#x27;ve used that to add strings to
clox, one of the most used types in most programming languages. Strings in turn
enable us to build another fundamental data type, especially in dynamic
languages: the venerable <a href="/docs/Craftinginterpreters/not-translated-yet/hash-tables.html">hash table</a>. But that&#x27;s for the next chapter...</p>
<div class="challenges">
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a href="#challenges" class="hash-link" aria-label="Challenges的直接链接" title="Challenges的直接链接">​</a></h2>
<ol>
<li>
<p>Each string requires two separate dynamic allocations -- one for the
ObjString and a second for the character array. Accessing the characters
from a value requires two pointer indirections, which can be bad for
performance. A more efficient solution relies on a technique called
<strong><a href="https://en.wikipedia.org/wiki/Flexible_array_member" target="_blank" rel="noopener noreferrer">flexible array members</a></strong>. Use that to store the ObjString and its
character array in a single contiguous allocation.</p>
</li>
<li>
<p>When we create the ObjString for each string literal, we copy the characters
onto the heap. That way, when the string is later freed, we know it is safe
to free the characters too.</p>
<p>This is a simpler approach but wastes some memory, which might be a problem
on very constrained devices. Instead, we could keep track of which
ObjStrings own their character array and which are &quot;constant strings&quot; that
just point back to the original source string or some other non-freeable
location. Add support for this.</p>
</li>
<li>
<p>If Lox was your language, what would you have it do when a user tries to use
<code>+</code> with one string operand and the other some other type? Justify your
choice. What do other languages do?</p>
</li>
</ol>
</div>
<div class="design-note">
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-note-string-encoding">Design Note: String Encoding<a href="#design-note-string-encoding" class="hash-link" aria-label="Design Note: String Encoding的直接链接" title="Design Note: String Encoding的直接链接">​</a></h2>
<p>In this book, I try not to shy away from the gnarly problems you&#x27;ll run into in
a real language implementation. We might not always use the most <em>sophisticated</em>
solution -- it&#x27;s an intro book after all -- but I don&#x27;t think it&#x27;s honest to
pretend the problem doesn&#x27;t exist at all. However, I did skirt around one really
nasty conundrum: deciding how to represent strings.</p>
<p>There are two facets to a string encoding:</p>
<ul>
<li>
<p><strong>What is a single &quot;character&quot; in a string?</strong> How many different values are
there and what do they represent? The first widely adopted standard answer
to this was <a href="https://en.wikipedia.org/wiki/ASCII" target="_blank" rel="noopener noreferrer">ASCII</a>. It gave you 127 different character values and
specified what they were. It was great... if you only ever cared about
English. While it has weird, mostly forgotten characters like &quot;record
separator&quot; and &quot;synchronous idle&quot;, it doesn&#x27;t have a single umlaut, acute,
or grave. It can&#x27;t represent &quot;jalapeño&quot;, &quot;naïve&quot;, <span name="gruyere">&quot;Gruyère&quot;</span>, or &quot;Mötley Crüe&quot;.</p>
<aside name="gruyere">
<p>It goes without saying that a language that does not let one discuss Gruyère
or Mötley Crüe is a language not worth using.</p>
</aside>
<p>Next came <a href="https://en.wikipedia.org/wiki/Unicode" target="_blank" rel="noopener noreferrer">Unicode</a>. Initially, it supported 16,384 different characters
(<strong>code points</strong>), which fit nicely in 16 bits with a couple of bits to
spare. Later that grew and grew, and now there are well over 100,000
different code points including such vital instruments of human
communication as 💩 (Unicode Character &#x27;PILE OF POO&#x27;, <code>U+1F4A9</code>).</p>
<p>Even that long list of code points is not enough to represent each possible
visible glyph a language might support. To handle that, Unicode also has
<strong>combining characters</strong> that modify a preceding code point. For example,
&quot;a&quot; followed by the combining character &quot;¨&quot; gives you &quot;ä&quot;. (To make things
more confusing Unicode <em>also</em> has a single code point that looks like &quot;ä&quot;.)</p>
<p>If a user accesses the fourth &quot;character&quot; in &quot;naïve&quot;, do they expect to get
back &quot;v&quot; or “¨”? The former means they are thinking of each code
point and its combining character as a single unit -- what Unicode calls an
<strong>extended grapheme cluster</strong> -- the latter means they are thinking in
individual code points. Which do your users expect?</p>
</li>
<li>
<p><strong>How is a single unit represented in memory?</strong> Most systems using ASCII
gave a single byte to each character and left the high bit unused. Unicode
has a handful of common encodings. UTF-16 packs most code points into 16
bits. That was great when every code point fit in that size. When that
overflowed, they added <em>surrogate pairs</em> that use multiple 16-bit code units
to represent a single code point. UTF-32 is the next evolution of
UTF-16 -- it gives a full 32 bits to each and every code point.</p>
<p>UTF-8 is more complex than either of those. It uses a variable number of
bytes to encode a code point. Lower-valued code points fit in fewer bytes.
Since each character may occupy a different number of bytes, you can&#x27;t
directly index into the string to find a specific code point. If you want,
say, the 10th code point, you don&#x27;t know how many bytes into the string that
is without walking and decoding all of the preceding ones.</p>
</li>
</ul>
<p>Choosing a character representation and encoding involves fundamental
trade-offs. Like many things in engineering, there&#x27;s no <span name="python">perfect</span> solution:</p>
<aside name="python">
<p>An example of how difficult this problem is comes from Python. The achingly long
transition from Python 2 to 3 is painful mostly because of its changes around
string encoding.</p>
</aside>
<ul>
<li>
<p>ASCII is memory efficient and fast, but it kicks non-Latin languages to the
side.</p>
</li>
<li>
<p>UTF-32 is fast and supports the whole Unicode range, but wastes a lot of
memory given that most code points do tend to be in the lower range of
values, where a full 32 bits aren&#x27;t needed.</p>
</li>
<li>
<p>UTF-8 is memory efficient and supports the whole Unicode range, but its
variable-length encoding makes it slow to access arbitrary code points.</p>
</li>
<li>
<p>UTF-16 is worse than all of them -- an ugly consequence of Unicode
outgrowing its earlier 16-bit range. It&#x27;s less memory efficient than UTF-8
but is still a variable-length encoding thanks to surrogate pairs. Avoid it
if you can. Alas, if your language needs to run on or interoperate with the
browser, the JVM, or the CLR, you might be stuck with it, since those all
use UTF-16 for their strings and you don&#x27;t want to have to convert every
time you pass a string to the underlying system.</p>
</li>
</ul>
<p>One option is to take the maximal approach and do the &quot;rightest&quot; thing. Support
all the Unicode code points. Internally, select an encoding for each string
based on its contents -- use ASCII if every code point fits in a byte, UTF-16 if
there are no surrogate pairs, etc. Provide APIs to let users iterate over both
code points and extended grapheme clusters.</p>
<p>This covers all your bases but is really complex. It&#x27;s a lot to implement,
debug, and optimize. When serializing strings or interoperating with other
systems, you have to deal with all of the encodings. Users need to understand
the two indexing APIs and know which to use when. This is the approach that
newer, big languages tend to take -- like Raku and Swift.</p>
<p>A simpler compromise is to always encode using UTF-8 and only expose an API that
works with code points. For users that want to work with grapheme clusters, let
them use a third-party library for that. This is less Latin-centric than ASCII
but not much more complex. You lose fast direct indexing by code point, but you
can usually live without that or afford to make it <em>O(n)</em> instead of <em>O(1)</em>.</p>
<p>If I were designing a big workhorse language for people writing large
applications, I&#x27;d probably go with the maximal approach. For my little embedded
scripting language <a href="http://wren.io" target="_blank" rel="noopener noreferrer">Wren</a>, I went with UTF-8 and code points.</p>
</div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/jabberwocky238/jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/strings.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Craftinginterpreters/not-translated-yet/statements-and-state"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">statements-and-state</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Craftinginterpreters/not-translated-yet/superclasses"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">superclasses</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#values-and-objects" class="table-of-contents__link toc-highlight">Values and Objects</a></li><li><a href="#struct-inheritance" class="table-of-contents__link toc-highlight">Struct Inheritance</a></li><li><a href="#strings" class="table-of-contents__link toc-highlight">Strings</a></li><li><a href="#operations-on-strings" class="table-of-contents__link toc-highlight">Operations on Strings</a><ul><li><a href="#concatenation" class="table-of-contents__link toc-highlight">Concatenation</a></li></ul></li><li><a href="#freeing-objects" class="table-of-contents__link toc-highlight">Freeing Objects</a></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a></li><li><a href="#design-note-string-encoding" class="table-of-contents__link toc-highlight">Design Note: String Encoding</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>