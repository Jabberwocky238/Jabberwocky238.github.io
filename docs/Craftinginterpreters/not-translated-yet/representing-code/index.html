<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Craftinginterpreters/not-translated-yet/representing-code" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">representing-code | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jabberwocky238.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jabberwocky238.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/representing-code"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="representing-code | My Site"><meta data-rh="true" name="description" content="To dwellers in a wood, almost every species of tree has its voice as well as"><meta data-rh="true" property="og:description" content="To dwellers in a wood, almost every species of tree has its voice as well as"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/representing-code"><link data-rh="true" rel="alternate" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/representing-code" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/representing-code" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.0d35426a.css">
<script src="/assets/js/runtime~main.0868a236.js" defer="defer"></script>
<script src="/assets/js/main.f1c02528.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jabberwocky238/jabberwocky238.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="展开侧边栏分类 &#x27;Tutorial - Basics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="展开侧边栏分类 &#x27;Tutorial - Extras&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/english">English</a><button aria-label="展开侧边栏分类 &#x27;English&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/crafting-interpreter">Crafting-interpreter</a><button aria-label="折叠侧边栏分类 &#x27;Crafting-interpreter&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/welcome">Welcome</a><button aria-label="展开侧边栏分类 &#x27;Welcome&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/not-translated-yet">not-translated-yet</a><button aria-label="折叠侧边栏分类 &#x27;not-translated-yet&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-bytecode-virtual-machine">a-bytecode-virtual-machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-tree-walk-interpreter">a-tree-walk-interpreter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-virtual-machine">a-virtual-machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/acknowledgements">acknowledgements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/appendix-i">appendix-i</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/appendix-ii">appendix-ii</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/backmatter">backmatter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/calls-and-functions">calls-and-functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/chunks-of-bytecode">chunks-of-bytecode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/classes-and-instances">classes-and-instances</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/classes">classes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/closures">closures</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/compiling-expressions">compiling-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/contents">contents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/control-flow">control-flow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/dedication">dedication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/evaluating-expressions">evaluating-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/functions">functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/garbage-collection">garbage-collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/global-variables">global-variables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/hash-tables">hash-tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/inheritance">inheritance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/jumping-back-and-forth">jumping-back-and-forth</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/local-variables">local-variables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/methods-and-initializers">methods-and-initializers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/optimization">optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/parsing-expressions">parsing-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/representing-code">representing-code</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/resolving-and-binding">resolving-and-binding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/scanning-on-demand">scanning-on-demand</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/scanning">scanning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/statements-and-state">statements-and-state</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/strings">strings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/superclasses">superclasses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/the-lox-language">the-lox-language</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/types-of-values">types-of-values</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/crafting-interpreter"><span itemprop="name">Crafting-interpreter</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/not-translated-yet"><span itemprop="name">not-translated-yet</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">representing-code</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>representing-code</h1></header><blockquote>
<p>To dwellers in a wood, almost every species of tree has its voice as well as
its feature.
<cite>Thomas Hardy, <em>Under the Greenwood Tree</em></cite></p>
</blockquote>
<p>In the <a href="/docs/Craftinginterpreters/not-translated-yet/scanning.html">last chapter</a>, we took the raw source code as a string and
transformed it into a slightly higher-level representation: a series of tokens.
The parser we&#x27;ll write in the <a href="/docs/Craftinginterpreters/not-translated-yet/parsing-expressions.html">next chapter</a> takes those tokens and
transforms them yet again, into an even richer, more complex representation.</p>
<p>Before we can produce that representation, we need to define it. That&#x27;s the
subject of this chapter. Along the way, we&#x27;ll <span name="boring">cover</span>
some theory around formal grammars, feel the difference between functional and
object-oriented programming, go over a couple of design patterns, and do some
metaprogramming.</p>
<aside name="boring">
<p>I was so worried about this being one of the most boring chapters in the book
that I kept stuffing more fun ideas into it until I ran out of room.</p>
</aside>
<p>Before we do all that, let&#x27;s focus on the main goal -- a representation for
code. It should be simple for the parser to produce and easy for the
interpreter to consume. If you haven&#x27;t written a parser or interpreter yet,
those requirements aren&#x27;t exactly illuminating. Maybe your intuition can help.
What is your brain doing when you play the part of a <em>human</em> interpreter? How do
you mentally evaluate an arithmetic expression like this:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1 + 2 * 3 - 4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Because you understand the order of operations -- the old &quot;<a href="https://en.wikipedia.org/wiki/Order_of_operations#Mnemonics" target="_blank" rel="noopener noreferrer">Please Excuse My
Dear Aunt Sally</a>&quot; stuff -- you know that the multiplication is evaluated
before the addition or subtraction. One way to visualize that precedence is
using a tree. Leaf nodes are numbers, and interior nodes are operators with
branches for each of their operands.</p>
<p>In order to evaluate an arithmetic node, you need to know the numeric values of
its subtrees, so you have to evaluate those first. That means working your way
from the leaves up to the root -- a <em>post-order</em> traversal:</p>
<p><span name="tree-steps"></span></p>
<img decoding="async" loading="lazy" src="image/representing-code/tree-evaluate.png" alt="Evaluating the tree from the bottom up." class="img_ev3q">
<aside name="tree-steps">
<p>A. Starting with the full tree, evaluate the bottom-most operation, <code>2 * 3</code>.</p>
<p>B. Now we can evaluate the <code>+</code>.</p>
<p>C. Next, the <code>-</code>.</p>
<p>D. The final answer.</p>
</aside>
<p>If I gave you an arithmetic expression, you could draw one of these trees pretty
easily. Given a tree, you can evaluate it without breaking a sweat. So it
intuitively seems like a workable representation of our code is a <span name="only">tree</span> that matches the grammatical structure -- the operator
nesting -- of the language.</p>
<aside name="only">
<p>That&#x27;s not to say a tree is the <em>only</em> possible representation of our code. In
<a href="/docs/Craftinginterpreters/not-translated-yet/a-bytecode-virtual-machine.html">Part III</a>, we&#x27;ll generate bytecode, another representation that isn&#x27;t as
human friendly but is closer to the machine.</p>
</aside>
<p>We need to get more precise about what that grammar is then. Like lexical
grammars in the last chapter, there is a long ton of theory around syntactic
grammars. We&#x27;re going into that theory a little more than we did when scanning
because it turns out to be a useful tool throughout much of the interpreter.
We start by moving one level up the <a href="https://en.wikipedia.org/wiki/Chomsky_hierarchy" target="_blank" rel="noopener noreferrer">Chomsky hierarchy</a>...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context-free-grammars">Context-Free Grammars<a href="#context-free-grammars" class="hash-link" aria-label="Context-Free Grammars的直接链接" title="Context-Free Grammars的直接链接">​</a></h2>
<p>In the last chapter, the formalism we used for defining the lexical grammar --
the rules for how characters get grouped into tokens -- was called a <em>regular
language</em>. That was fine for our scanner, which emits a flat sequence of tokens.
But regular languages aren&#x27;t powerful enough to handle expressions which can
nest arbitrarily deeply.</p>
<p>We need a bigger hammer, and that hammer is a <strong>context-free grammar</strong>
(<strong>CFG</strong>). It&#x27;s the next heaviest tool in the toolbox of
<strong><a href="https://en.wikipedia.org/wiki/Formal_grammar" target="_blank" rel="noopener noreferrer">formal grammars</a></strong>. A formal grammar takes a set of atomic pieces it calls
its &quot;alphabet&quot;. Then it defines a (usually infinite) set of &quot;strings&quot; that are
&quot;in&quot; the grammar. Each string is a sequence of &quot;letters&quot; in the alphabet.</p>
<p>I&#x27;m using all those quotes because the terms get a little confusing as you move
from lexical to syntactic grammars. In our scanner&#x27;s grammar, the alphabet
consists of individual characters and the strings are the valid lexemes --
roughly &quot;words&quot;. In the syntactic grammar we&#x27;re talking about now, we&#x27;re at a
different level of granularity. Now each &quot;letter&quot; in the alphabet is an entire
token and a &quot;string&quot; is a sequence of <em>tokens</em> -- an entire expression.</p>
<p>Oof. Maybe a table will help:</p>
<table><thead><tr>
  <td>Terminology</td>
  <td></td>
  <td>Lexical grammar</td>
  <td>Syntactic grammar</td></tr></thead><tbody><tr>
  <td>The “alphabet” is<span class="ellipse"> . . .</span></td>
  <td>→ </td>
  <td>Characters</td>
  <td>Tokens</td></tr><tr>
  <td>A “string” is<span class="ellipse"> . . .</span></td>
  <td>→ </td>
  <td>Lexeme or token</td>
  <td>Expression</td></tr><tr>
  <td>It’s implemented by the<span class="ellipse"> . . .</span></td>
  <td>→ </td>
  <td>Scanner</td>
  <td>Parser</td></tr></tbody></table>
<p>A formal grammar&#x27;s job is to specify which strings are valid and which aren&#x27;t.
If we were defining a grammar for English sentences, &quot;eggs are tasty for
breakfast&quot; would be in the grammar, but &quot;tasty breakfast for are eggs&quot; would
probably not.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rules-for-grammars">Rules for grammars<a href="#rules-for-grammars" class="hash-link" aria-label="Rules for grammars的直接链接" title="Rules for grammars的直接链接">​</a></h3>
<p>How do we write down a grammar that contains an infinite number of valid
strings? We obviously can&#x27;t list them all out. Instead, we create a finite set
of rules. You can think of them as a game that you can &quot;play&quot; in one of two
directions.</p>
<p>If you start with the rules, you can use them to <em>generate</em> strings that are in
the grammar. Strings created this way are called <strong>derivations</strong> because each is
<em>derived</em> from the rules of the grammar. In each step of the game, you pick a
rule and follow what it tells you to do. Most of the lingo around formal
grammars comes from playing them in this direction. Rules are called
<strong>productions</strong> because they <em>produce</em> strings in the grammar.</p>
<p>Each production in a context-free grammar has a <strong>head</strong> -- its <span name="name">name</span> -- and a <strong>body</strong>, which describes what it generates. In
its pure form, the body is simply a list of symbols. Symbols come in two
delectable flavors:</p>
<aside name="name">
<p>Restricting heads to a single symbol is a defining feature of context-free
grammars. More powerful formalisms like <strong><a href="https://en.wikipedia.org/wiki/Unrestricted_grammar" target="_blank" rel="noopener noreferrer">unrestricted grammars</a></strong> allow a
sequence of symbols in the head as well as in the body.</p>
</aside>
<ul>
<li>
<p>A <strong>terminal</strong> is a letter from the grammar&#x27;s alphabet. You can think of it
like a literal value. In the syntactic grammar we&#x27;re defining, the terminals
are individual lexemes -- tokens coming from the scanner like <code>if</code> or
<code>1234</code>.</p>
<p>These are called &quot;terminals&quot;, in the sense of an &quot;end point&quot; because they
don&#x27;t lead to any further &quot;moves&quot; in the game. You simply produce that one
symbol.</p>
</li>
<li>
<p>A <strong>nonterminal</strong> is a named reference to another rule in the grammar. It
means &quot;play that rule and insert whatever it produces here&quot;. In this way,
the grammar composes.</p>
</li>
</ul>
<p>There is one last refinement: you may have multiple rules with the same name.
When you reach a nonterminal with that name, you are allowed to pick any of the
rules for it, whichever floats your boat.</p>
<p>To make this concrete, we need a <span name="turtles">way</span> to write down
these production rules. People have been trying to crystallize grammar all the
way back to Pāṇini&#x27;s <em>Ashtadhyayi</em>, which codified Sanskrit grammar a mere
couple thousand years ago. Not much progress happened until John Backus and
company needed a notation for specifying ALGOL 58 and came up with
<a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form" target="_blank" rel="noopener noreferrer"><strong>Backus-Naur form</strong></a> (<strong>BNF</strong>). Since then, nearly everyone uses some
flavor of BNF, tweaked to their own tastes.</p>
<p>I tried to come up with something clean. Each rule is a name, followed by an
arrow (<code>→</code>), followed by a sequence of symbols, and finally ending with a
semicolon (<code>;</code>). Terminals are quoted strings, and nonterminals are lowercase
words.</p>
<aside name="turtles">
<p>Yes, we need to define a syntax to use for the rules that define our syntax.
Should we specify that <em>metasyntax</em> too? What notation do we use for <em>it?</em> It&#x27;s
languages all the way down!</p>
</aside>
<p>Using that, here&#x27;s a grammar for <span name="breakfast">breakfast</span> menus:</p>
<aside name="breakfast">
<p>Yes, I really am going to be using breakfast examples throughout this entire
book. Sorry.</p>
</aside>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">breakfast  → protein &quot;with&quot; breakfast &quot;on the side&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">breakfast  → protein ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">breakfast  → bread ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">protein    → crispiness &quot;crispy&quot; &quot;bacon&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">protein    → &quot;sausage&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">protein    → cooked &quot;eggs&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">crispiness → &quot;really&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">crispiness → &quot;really&quot; crispiness ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cooked     → &quot;scrambled&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cooked     → &quot;poached&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cooked     → &quot;fried&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bread      → &quot;toast&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bread      → &quot;biscuits&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bread      → &quot;English muffin&quot; ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can use this grammar to generate random breakfasts. Let&#x27;s play a round and
see how it works. By age-old convention, the game starts with the first rule in
the grammar, here <code>breakfast</code>. There are three productions for that, and we
randomly pick the first one. Our resulting string looks like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">protein &quot;with&quot; breakfast &quot;on the side&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We need to expand that first nonterminal, <code>protein</code>, so we pick a production for
that. Let&#x27;s pick:</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">protein → cooked &quot;eggs&quot; ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we need a production for <code>cooked</code>, and so we pick <code>&quot;poached&quot;</code>. That&#x27;s a
terminal, so we add that. Now our string looks like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;poached&quot; &quot;eggs&quot; &quot;with&quot; breakfast &quot;on the side&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The next non-terminal is <code>breakfast</code> again. The first <code>breakfast</code> production we
chose recursively refers back to the <code>breakfast</code> rule. Recursion in the grammar
is a good sign that the language being defined is context-free instead of
regular. In particular, recursion where the recursive nonterminal has
productions on <span name="nest">both</span> sides implies that the language is
not regular.</p>
<aside name="nest">
<p>Imagine that we&#x27;ve recursively expanded the <code>breakfast</code> rule here several times,
like &quot;bacon with bacon with bacon with...&quot; In order to complete the string
correctly, we need to add an <em>equal</em> number of &quot;on the side&quot; bits to the end.
Tracking the number of required trailing parts is beyond the capabilities of a
regular grammar. Regular grammars can express <em>repetition</em>, but they can&#x27;t <em>keep
count</em> of how many repetitions there are, which is necessary to ensure that the
string has the same number of <code>with</code> and <code>on the side</code> parts.</p>
</aside>
<p>We could keep picking the first production for <code>breakfast</code> over and over again
yielding all manner of breakfasts like &quot;bacon with sausage with scrambled eggs
with bacon...&quot; We won&#x27;t though. This time we&#x27;ll pick <code>bread</code>. There are three
rules for that, each of which contains only a terminal. We&#x27;ll pick &quot;English
muffin&quot;.</p>
<p>With that, every nonterminal in the string has been expanded until it finally
contains only terminals and we&#x27;re left with:</p>
<img decoding="async" loading="lazy" src="image/representing-code/breakfast.png" alt="&quot;Playing&quot; the grammar to generate a string." class="img_ev3q">
<p>Throw in some ham and Hollandaise, and you&#x27;ve got eggs Benedict.</p>
<p>Any time we hit a rule that had multiple productions, we just picked one
arbitrarily. It is this flexibility that allows a short number of grammar rules
to encode a combinatorially larger set of strings. The fact that a rule can
refer to itself -- directly or indirectly -- kicks it up even more, letting us
pack an infinite number of strings into a finite grammar.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enhancing-our-notation">Enhancing our notation<a href="#enhancing-our-notation" class="hash-link" aria-label="Enhancing our notation的直接链接" title="Enhancing our notation的直接链接">​</a></h3>
<p>Stuffing an infinite set of strings in a handful of rules is pretty fantastic,
but let&#x27;s take it further. Our notation works, but it&#x27;s tedious. So, like any
good language designer, we&#x27;ll sprinkle a little syntactic sugar on top -- some
extra convenience notation. In addition to terminals and nonterminals, we&#x27;ll
allow a few other kinds of expressions in the body of a rule:</p>
<ul>
<li>
<p>Instead of repeating the rule name each time we want to add another
production for it, we&#x27;ll allow a series of productions separated by a pipe
(<code>|</code>).</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">bread → &quot;toast&quot; | &quot;biscuits&quot; | &quot;English muffin&quot; ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Further, we&#x27;ll allow parentheses for grouping and then allow <code>|</code> within that
to select one from a series of options within the middle of a production.</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">protein → ( &quot;scrambled&quot; | &quot;poached&quot; | &quot;fried&quot; ) &quot;eggs&quot; ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Using recursion to support repeated sequences of symbols has a certain
appealing <span name="purity">purity</span>, but it&#x27;s kind of a chore to
make a separate named sub-rule each time we want to loop. So, we also use a
postfix <code>*</code> to allow the previous symbol or group to be repeated zero or
more times.</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">crispiness → &quot;really&quot; &quot;really&quot;* ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<aside name="purity">
<p>This is how the Scheme programming language works. It has no built-in looping
functionality at all. Instead, <em>all</em> repetition is expressed in terms of
recursion.</p>
</aside>
<ul>
<li>
<p>A postfix <code>+</code> is similar, but requires the preceding production to appear
at least once.</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">crispiness → &quot;really&quot;+ ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>A postfix <code>?</code> is for an optional production. The thing before it can appear
zero or one time, but not more.</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">breakfast → protein ( &quot;with&quot; breakfast &quot;on the side&quot; )? ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>With all of those syntactic niceties, our breakfast grammar condenses down to:</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">breakfast → protein ( &quot;with&quot; breakfast &quot;on the side&quot; )?</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          | bread ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">protein   → &quot;really&quot;+ &quot;crispy&quot; &quot;bacon&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          | &quot;sausage&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          | ( &quot;scrambled&quot; | &quot;poached&quot; | &quot;fried&quot; ) &quot;eggs&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bread     → &quot;toast&quot; | &quot;biscuits&quot; | &quot;English muffin&quot; ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Not too bad, I hope. If you&#x27;re used to grep or using <a href="https://en.wikipedia.org/wiki/Regular_expression#Standards" target="_blank" rel="noopener noreferrer">regular
expressions</a> in your text editor, most of the punctuation should be
familiar. The main difference is that symbols here represent entire tokens, not
single characters.</p>
<p>We&#x27;ll use this notation throughout the rest of the book to precisely describe
Lox&#x27;s grammar. As you work on programming languages, you&#x27;ll find that
context-free grammars (using this or <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form" target="_blank" rel="noopener noreferrer">EBNF</a> or some other notation) help you
crystallize your informal syntax design ideas. They are also a handy medium for
communicating with other language hackers about syntax.</p>
<p>The rules and productions we define for Lox are also our guide to the tree data
structure we&#x27;re going to implement to represent code in memory. Before we can do
that, we need an actual grammar for Lox, or at least enough of one for us to get
started.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-grammar-for-lox-expressions">A Grammar for Lox expressions<a href="#a-grammar-for-lox-expressions" class="hash-link" aria-label="A Grammar for Lox expressions的直接链接" title="A Grammar for Lox expressions的直接链接">​</a></h3>
<p>In the previous chapter, we did Lox&#x27;s entire lexical grammar in one fell swoop.
Every keyword and bit of punctuation is there. The syntactic grammar is larger,
and it would be a real bore to grind through the entire thing before we actually
get our interpreter up and running.</p>
<p>Instead, we&#x27;ll crank through a subset of the language in the next couple of
chapters. Once we have that mini-language represented, parsed, and interpreted,
then later chapters will progressively add new features to it, including the new
syntax. For now, we are going to worry about only a handful of expressions:</p>
<ul>
<li>
<p><strong>Literals.</strong> Numbers, strings, Booleans, and <code>nil</code>.</p>
</li>
<li>
<p><strong>Unary expressions.</strong> A prefix <code>!</code> to perform a logical not, and <code>-</code> to
negate a number.</p>
</li>
<li>
<p><strong>Binary expressions.</strong> The infix arithmetic (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>) and logic
operators (<code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>) we know and love.</p>
</li>
<li>
<p><strong>Parentheses.</strong> A pair of <code>(</code> and <code>)</code> wrapped around an expression.</p>
</li>
</ul>
<p>That gives us enough syntax for expressions like:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1 - (2 * 3) &lt; 4 == false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using our handy dandy new notation, here&#x27;s a grammar for those:</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">expression     → literal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | unary</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | binary</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | grouping ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">literal        → NUMBER | STRING | &quot;true&quot; | &quot;false&quot; | &quot;nil&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">grouping       → &quot;(&quot; expression &quot;)&quot; ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unary          → ( &quot;-&quot; | &quot;!&quot; ) expression ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">binary         → expression operator expression ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">operator       → &quot;==&quot; | &quot;!=&quot; | &quot;&lt;&quot; | &quot;&lt;=&quot; | &quot;&gt;&quot; | &quot;&gt;=&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | &quot;+&quot;  | &quot;-&quot;  | &quot;*&quot; | &quot;/&quot; ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There&#x27;s one bit of extra <span name="play">metasyntax</span> here. In addition
to quoted strings for terminals that match exact lexemes, we <code>CAPITALIZE</code>
terminals that are a single lexeme whose text representation may vary. <code>NUMBER</code>
is any number literal, and <code>STRING</code> is any string literal. Later, we&#x27;ll do the
same for <code>IDENTIFIER</code>.</p>
<p>This grammar is actually ambiguous, which we&#x27;ll see when we get to parsing it.
But it&#x27;s good enough for now.</p>
<aside name="play">
<p>If you&#x27;re so inclined, try using this grammar to generate a few expressions like
we did with the breakfast grammar before. Do the resulting expressions look
right to you? Can you make it generate anything wrong like <code>1 + / 3</code>?</p>
</aside>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-syntax-trees">Implementing Syntax Trees<a href="#implementing-syntax-trees" class="hash-link" aria-label="Implementing Syntax Trees的直接链接" title="Implementing Syntax Trees的直接链接">​</a></h2>
<p>Finally, we get to write some code. That little expression grammar is our
skeleton. Since the grammar is recursive -- note how <code>grouping</code>, <code>unary</code>, and
<code>binary</code> all refer back to <code>expression</code> -- our data structure will form a tree.
Since this structure represents the syntax of our language, it&#x27;s called a <span name="ast"><strong>syntax tree</strong></span>.</p>
<aside name="ast">
<p>In particular, we&#x27;re defining an <strong>abstract syntax tree</strong> (<strong>AST</strong>). In a
<strong>parse tree</strong>, every single grammar production becomes a node in the tree. An
AST elides productions that aren&#x27;t needed by later phases.</p>
</aside>
<p>Our scanner used a single Token class to represent all kinds of lexemes. To
distinguish the different kinds -- think the number <code>123</code> versus the string
<code>&quot;123&quot;</code> -- we included a simple TokenType enum. Syntax trees are not so <span name="token-data">homogeneous</span>. Unary expressions have a single operand,
binary expressions have two, and literals have none.</p>
<p>We <em>could</em> mush that all together into a single Expression class with an
arbitrary list of children. Some compilers do. But I like getting the most out
of Java&#x27;s type system. So we&#x27;ll define a base class for expressions. Then, for
each kind of expression -- each production under <code>expression</code> -- we create a
subclass that has fields for the nonterminals specific to that rule. This way,
we get a compile error if we, say, try to access the second operand of a unary
expression.</p>
<aside name="token-data">
<p>Tokens aren&#x27;t entirely homogeneous either. Tokens for literals store the value,
but other kinds of lexemes don&#x27;t need that state. I have seen scanners that use
different classes for literals and other kinds of lexemes, but I figured I&#x27;d
keep things simpler.</p>
</aside>
<p>Something like this:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.craftinginterpreters.lox;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">abstract class Expr { // [expr]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  static class Binary extends Expr {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Binary(Expr left, Token operator, Expr right) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      this.left = left;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      this.operator = operator;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      this.right = right;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final Expr left;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final Token operator;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    final Expr right;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // Other expressions...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<aside name="expr">
<p>I avoid abbreviations in my code because they trip up a reader who doesn&#x27;t know
what they stand for. But in compilers I&#x27;ve looked at, &quot;Expr&quot; and &quot;Stmt&quot; are so
ubiquitous that I may as well start getting you used to them now.</p>
</aside>
<p>Expr is the base class that all expression classes inherit from. As you can see
from <code>Binary</code>, the subclasses are nested inside of it. There&#x27;s no technical need
for this, but it lets us cram all of the classes into a single Java file.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="disoriented-objects">Disoriented objects<a href="#disoriented-objects" class="hash-link" aria-label="Disoriented objects的直接链接" title="Disoriented objects的直接链接">​</a></h3>
<p>You&#x27;ll note that, much like the Token class, there aren&#x27;t any methods here. It&#x27;s
a dumb structure. Nicely typed, but merely a bag of data. This feels strange in
an object-oriented language like Java. Shouldn&#x27;t the class <em>do stuff</em>?</p>
<p>The problem is that these tree classes aren&#x27;t owned by any single domain. Should
they have methods for parsing since that&#x27;s where the trees are created? Or
interpreting since that&#x27;s where they are consumed? Trees span the border between
those territories, which means they are really owned by <em>neither</em>.</p>
<p>In fact, these types exist to enable the parser and interpreter to
<em>communicate</em>. That lends itself to types that are simply data with no
associated behavior. This style is very natural in functional languages like
Lisp and ML where <em>all</em> data is separate from behavior, but it feels odd in
Java.</p>
<p>Functional programming aficionados right now are jumping up to exclaim &quot;See!
Object-oriented languages are a bad fit for an interpreter!&quot; I won&#x27;t go that
far. You&#x27;ll recall that the scanner itself was admirably suited to
object-orientation. It had all of the mutable state to keep track of where it
was in the source code, a well-defined set of public methods, and a handful of
private helpers.</p>
<p>My feeling is that each phase or part of the interpreter works fine in an
object-oriented style. It is the data structures that flow between them that are
stripped of behavior.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="metaprogramming-the-trees">Metaprogramming the trees<a href="#metaprogramming-the-trees" class="hash-link" aria-label="Metaprogramming the trees的直接链接" title="Metaprogramming the trees的直接链接">​</a></h3>
<p>Java can express behavior-less classes, but I wouldn&#x27;t say that it&#x27;s
particularly great at it. Eleven lines of code to stuff three fields in an
object is pretty tedious, and when we&#x27;re all done, we&#x27;re going to have 21 of
these classes.</p>
<p>I don&#x27;t want to waste your time or my ink writing all that down. Really, what is
the essence of each subclass? A name, and a list of typed fields. That&#x27;s it.
We&#x27;re smart language hackers, right? Let&#x27;s <span name="automate">automate</span>.</p>
<aside name="automate">
<p>Picture me doing an awkward robot dance when you read that. &quot;AU-TO-MATE.&quot;</p>
</aside>
<p>Instead of tediously handwriting each class definition, field declaration,
constructor, and initializer, we&#x27;ll hack together a <span name="python">script</span> that does it for us. It has a description of each
tree type -- its name and fields -- and it prints out the Java code needed to
define a class with that name and state.</p>
<p>This script is a tiny Java command-line app that generates a file named
&quot;Expr.java&quot;:</p>
<aside name="python">
<p>I got the idea of scripting the syntax tree classes from Jim Hugunin, creator of
Jython and IronPython.</p>
<p>An actual scripting language would be a better fit for this than Java, but I&#x27;m
trying not to throw too many languages at you.</p>
</aside>
<p>^code generate-ast</p>
<p>Note that this file is in a different package, <code>.tool</code> instead of <code>.lox</code>. This
script isn&#x27;t part of the interpreter itself. It&#x27;s a tool <em>we</em>, the people
hacking on the interpreter, run ourselves to generate the syntax tree classes.
When it&#x27;s done, we treat &quot;Expr.java&quot; like any other file in the implementation.
We are merely automating how that file gets authored.</p>
<p>To generate the classes, it needs to have some description of each type and its
fields.</p>
<p>^code call-define-ast (1 before, 1 after)</p>
<p>For brevity&#x27;s sake, I jammed the descriptions of the expression types into
strings. Each is the name of the class followed by <code>:</code> and the list of fields,
separated by commas. Each field has a type and a name.</p>
<p>The first thing <code>defineAst()</code> needs to do is output the base Expr class.</p>
<p>^code define-ast</p>
<p>When we call this, <code>baseName</code> is &quot;Expr&quot;, which is both the name of the class and
the name of the file it outputs. We pass this as an argument instead of
hardcoding the name because we&#x27;ll add a separate family of classes later for
statements.</p>
<p>Inside the base class, we define each subclass.</p>
<p>^code nested-classes (2 before, 1 after)</p>
<aside name="robust">
<p>This isn&#x27;t the world&#x27;s most elegant string manipulation code, but that&#x27;s fine.
It only runs on the exact set of class definitions we give it. Robustness ain&#x27;t
a priority.</p>
</aside>
<p>That code, in turn, calls:</p>
<p>^code define-type</p>
<p>There we go. All of that glorious Java boilerplate is done. It declares each
field in the class body. It defines a constructor for the class with parameters
for each field and initializes them in the body.</p>
<p>Compile and run this Java program now and it <span name="longer">blasts</span>
out a new “.java&quot; file containing a few dozen lines of code. That file&#x27;s
about to get even longer.</p>
<aside name="longer">
<p><a href="/docs/Craftinginterpreters/not-translated-yet/appendix-ii.html">Appendix II</a> contains the code generated by this script once we&#x27;ve finished
implementing jlox and defined all of its syntax tree nodes.</p>
</aside>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="working-with-trees">Working with Trees<a href="#working-with-trees" class="hash-link" aria-label="Working with Trees的直接链接" title="Working with Trees的直接链接">​</a></h2>
<p>Put on your imagination hat for a moment. Even though we aren&#x27;t there yet,
consider what the interpreter will do with the syntax trees. Each kind of
expression in Lox behaves differently at runtime. That means the interpreter
needs to select a different chunk of code to handle each expression type. With
tokens, we can simply switch on the TokenType. But we don&#x27;t have a &quot;type&quot; enum
for the syntax trees, just a separate Java class for each one.</p>
<p>We could write a long chain of type tests:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (expr instanceof Expr.Binary) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else if (expr instanceof Expr.Grouping) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else // ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But all of those sequential type tests are slow. Expression types whose names
are alphabetically later would take longer to execute because they&#x27;d fall
through more <code>if</code> cases before finding the right type. That&#x27;s not my idea of an
elegant solution.</p>
<p>We have a family of classes and we need to associate a chunk of behavior with
each one. The natural solution in an object-oriented language like Java is to
put those behaviors into methods on the classes themselves. We could add an
abstract <span name="interpreter-pattern"><code>interpret()</code></span> method on Expr
which each subclass would then implement to interpret itself.</p>
<aside name="interpreter-pattern">
<p>This exact thing is literally called the <a href="https://en.wikipedia.org/wiki/Interpreter_pattern" target="_blank" rel="noopener noreferrer">&quot;Interpreter pattern&quot;</a> in
<em>Design Patterns: Elements of Reusable Object-Oriented Software</em>, by Erich
Gamma, et al.</p>
</aside>
<p>This works alright for tiny projects, but it scales poorly. Like I noted before,
these tree classes span a few domains. At the very least, both the parser and
interpreter will mess with them. As <a href="/docs/Craftinginterpreters/not-translated-yet/resolving-and-binding.html">you&#x27;ll see later</a>, we need to
do name resolution on them. If our language was statically typed, we&#x27;d have a
type checking pass.</p>
<p>If we added instance methods to the expression classes for every one of those
operations, that would smush a bunch of different domains together. That
violates <a href="https://en.wikipedia.org/wiki/Separation_of_concerns" target="_blank" rel="noopener noreferrer">separation of concerns</a> and leads to hard-to-maintain code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-expression-problem">The expression problem<a href="#the-expression-problem" class="hash-link" aria-label="The expression problem的直接链接" title="The expression problem的直接链接">​</a></h3>
<p>This problem is more fundamental than it may seem at first. We have a handful of
types, and a handful of high-level operations like &quot;interpret&quot;. For each pair of
type and operation, we need a specific implementation. Picture a table:</p>
<img decoding="async" loading="lazy" src="image/representing-code/table.png" alt="A table where rows are labeled with expression classes, and columns are function names." class="img_ev3q">
<p>Rows are types, and columns are operations. Each cell represents the unique
piece of code to implement that operation on that type.</p>
<p>An object-oriented language like Java assumes that all of the code in one row
naturally hangs together. It figures all the things you do with a type are
likely related to each other, and the language makes it easy to define them
together as methods inside the same class.</p>
<img decoding="async" loading="lazy" src="image/representing-code/rows.png" alt="The table split into rows for each class." class="img_ev3q">
<p>This makes it easy to extend the table by adding new rows. Simply define a new
class. No existing code has to be touched. But imagine if you want to add a new
<em>operation</em> -- a new column. In Java, that means cracking open each of those
existing classes and adding a method to it.</p>
<p>Functional paradigm languages in the <span name="ml">ML</span> family flip that
around. There, you don&#x27;t have classes with methods. Types and functions are
totally distinct. To implement an operation for a number of different types, you
define a single function. In the body of that function, you use <em>pattern
matching</em> -- sort of a type-based switch on steroids -- to implement the
operation for each type all in one place.</p>
<aside name="ml">
<p>ML, short for &quot;metalanguage&quot; was created by Robin Milner and friends and forms
one of the main branches in the great programming language family tree. Its
children include SML, Caml, OCaml, Haskell, and F#. Even Scala, Rust, and Swift
bear a strong resemblance.</p>
<p>Much like Lisp, it is one of those languages that is so full of good ideas that
language designers today are still rediscovering them over forty years later.</p>
</aside>
<p>This makes it trivial to add new operations -- simply define another function
that pattern matches on all of the types.</p>
<img decoding="async" loading="lazy" src="image/representing-code/columns.png" alt="The table split into columns for each function." class="img_ev3q">
<p>But, conversely, adding a new type is hard. You have to go back and add a new
case to all of the pattern matches in all of the existing functions.</p>
<p>Each style has a certain &quot;grain&quot; to it. That&#x27;s what the paradigm name literally
says -- an object-oriented language wants you to <em>orient</em> your code along the
rows of types. A functional language instead encourages you to lump each
column&#x27;s worth of code together into a <em>function</em>.</p>
<p>A bunch of smart language nerds noticed that neither style made it easy to add
<em>both</em> rows and columns to the <span name="multi">table</span>. They called this
difficulty the &quot;expression problem&quot; because -- like we are now -- they first ran
into it when they were trying to figure out the best way to model expression
syntax tree nodes in a compiler.</p>
<aside name="multi">
<p>Languages with <em>multimethods</em>, like Common Lisp&#x27;s CLOS, Dylan, and Julia do
support adding both new types and operations easily. What they typically
sacrifice is either static type checking, or separate compilation.</p>
</aside>
<p>People have thrown all sorts of language features, design patterns, and
programming tricks to try to knock that problem down but no perfect language has
finished it off yet. In the meantime, the best we can do is try to pick a
language whose orientation matches the natural architectural seams in the
program we&#x27;re writing.</p>
<p>Object-orientation works fine for many parts of our interpreter, but these tree
classes rub against the grain of Java. Fortunately, there&#x27;s a design pattern we
can bring to bear on it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-visitor-pattern">The Visitor pattern<a href="#the-visitor-pattern" class="hash-link" aria-label="The Visitor pattern的直接链接" title="The Visitor pattern的直接链接">​</a></h3>
<p>The <strong>Visitor pattern</strong> is the most widely misunderstood pattern in all of
<em>Design Patterns</em>, which is really saying something when you look at the
software architecture excesses of the past couple of decades.</p>
<p>The trouble starts with terminology. The pattern isn&#x27;t about &quot;visiting&quot;, and the
&quot;accept&quot; method in it doesn&#x27;t conjure up any helpful imagery either. Many think
the pattern has to do with traversing trees, which isn&#x27;t the case at all. We
<em>are</em> going to use it on a set of classes that are tree-like, but that&#x27;s a
coincidence. As you&#x27;ll see, the pattern works as well on a single object.</p>
<p>The Visitor pattern is really about approximating the functional style within an
OOP language. It lets us add new columns to that table easily. We can define all
of the behavior for a new operation on a set of types in one place, without
having to touch the types themselves. It does this the same way we solve almost
every problem in computer science: by adding a layer of indirection.</p>
<p>Before we apply it to our auto-generated Expr classes, let&#x27;s walk through a
simpler example. Say we have two kinds of pastries: <span name="beignet">beignets</span> and crullers.</p>
<aside name="beignet">
<p>A beignet (pronounced &quot;ben-yay&quot;, with equal emphasis on both syllables) is a
deep-fried pastry in the same family as doughnuts. When the French colonized
North America in the 1700s, they brought beignets with them. Today, in the US,
they are most strongly associated with the cuisine of New Orleans.</p>
<p>My preferred way to consume them is fresh out of the fryer at Café du Monde,
piled high in powdered sugar, and washed down with a cup of café au lait while I
watch tourists staggering around trying to shake off their hangover from the
previous night&#x27;s revelry.</p>
</aside>
<p>^code pastries (no location)</p>
<p>We want to be able to define new pastry operations -- cooking them, eating them,
decorating them, etc. -- without having to add a new method to each class every
time. Here&#x27;s how we do it. First, we define a separate interface.</p>
<p>^code pastry-visitor (no location)</p>
<aside name="overload">
<p>In <em>Design Patterns</em>, both of these methods are confusingly named <code>visit()</code>, and
they rely on overloading to distinguish them. This leads some readers to think
that the correct visit method is chosen <em>at runtime</em> based on its parameter
type. That isn&#x27;t the case. Unlike over<em>riding</em>, over<em>loading</em> is statically
dispatched at compile time.</p>
<p>Using distinct names for each method makes the dispatch more obvious, and also
shows you how to apply this pattern in languages that don&#x27;t support overloading.</p>
</aside>
<p>Each operation that can be performed on pastries is a new class that implements
that interface. It has a concrete method for each type of pastry. That keeps the
code for the operation on both types all nestled snugly together in one class.</p>
<p>Given some pastry, how do we route it to the correct method on the visitor based
on its type? Polymorphism to the rescue! We add this method to Pastry:</p>
<p>^code pastry-accept (1 before, 1 after, no location)</p>
<p>Each subclass implements it.</p>
<p>^code beignet-accept (1 before, 1 after, no location)</p>
<p>And:</p>
<p>^code cruller-accept (1 before, 1 after, no location)</p>
<p>To perform an operation on a pastry, we call its <code>accept()</code> method and pass in
the visitor for the operation we want to execute. The pastry -- the specific
subclass&#x27;s overriding implementation of <code>accept()</code> -- turns around and calls the
appropriate visit method on the visitor and passes <em>itself</em> to it.</p>
<p>That&#x27;s the heart of the trick right there. It lets us use polymorphic dispatch
on the <em>pastry</em> classes to select the appropriate method on the <em>visitor</em> class.
In the table, each pastry class is a row, but if you look at all of the methods
for a single visitor, they form a <em>column</em>.</p>
<img decoding="async" loading="lazy" src="image/representing-code/visitor.png" alt="Now all of the cells for one operation are part of the same class, the visitor." class="img_ev3q">
<p>We added one <code>accept()</code> method to each class, and we can use it for as many
visitors as we want without ever having to touch the pastry classes again. It&#x27;s
a clever pattern.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="visitors-for-expressions">Visitors for expressions<a href="#visitors-for-expressions" class="hash-link" aria-label="Visitors for expressions的直接链接" title="Visitors for expressions的直接链接">​</a></h3>
<p>OK, let&#x27;s weave it into our expression classes. We&#x27;ll also <span name="context">refine</span> the pattern a little. In the pastry example, the
visit and <code>accept()</code> methods don&#x27;t return anything. In practice, visitors often
want to define operations that produce values. But what return type should
<code>accept()</code> have? We can&#x27;t assume every visitor class wants to produce the same
type, so we&#x27;ll use generics to let each implementation fill in a return type.</p>
<aside name="context">
<p>Another common refinement is an additional &quot;context&quot; parameter that is passed to
the visit methods and then sent back through as a parameter to <code>accept()</code>. That
lets operations take an additional parameter. The visitors we&#x27;ll define in the
book don&#x27;t need that, so I omitted it.</p>
</aside>
<p>First, we define the visitor interface. Again, we nest it inside the base class
so that we can keep everything in one file.</p>
<p>^code call-define-visitor (2 before, 1 after)</p>
<p>That function generates the visitor interface.</p>
<p>^code define-visitor</p>
<p>Here, we iterate through all of the subclasses and declare a visit method for
each one. When we define new expression types later, this will automatically
include them.</p>
<p>Inside the base class, we define the abstract <code>accept()</code> method.</p>
<p>^code base-accept-method (2 before, 1 after)</p>
<p>Finally, each subclass implements that and calls the right visit method for its
own type.</p>
<p>^code accept-method (1 before, 2 after)</p>
<p>There we go. Now we can define operations on expressions without having to muck
with the classes or our generator script. Compile and run this generator script
to output an updated &quot;Expr.java&quot; file. It contains a generated Visitor
interface and a set of expression node classes that support the Visitor pattern
using it.</p>
<p>Before we end this rambling chapter, let&#x27;s implement that Visitor interface and
see the pattern in action.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-not-very-pretty-printer">A (Not Very) Pretty Printer<a href="#a-not-very-pretty-printer" class="hash-link" aria-label="A (Not Very) Pretty Printer的直接链接" title="A (Not Very) Pretty Printer的直接链接">​</a></h2>
<p>When we debug our parser and interpreter, it&#x27;s often useful to look at a parsed
syntax tree and make sure it has the structure we expect. We could inspect it in
the debugger, but that can be a chore.</p>
<p>Instead, we&#x27;d like some code that, given a syntax tree, produces an unambiguous
string representation of it. Converting a tree to a string is sort of the
opposite of a parser, and is often called &quot;pretty printing&quot; when the goal is to
produce a string of text that is valid syntax in the source language.</p>
<p>That&#x27;s not our goal here. We want the string to very explicitly show the nesting
structure of the tree. A printer that returned <code>1 + 2 * 3</code> isn&#x27;t super helpful
if what we&#x27;re trying to debug is whether operator precedence is handled
correctly. We want to know if the <code>+</code> or <code>*</code> is at the top of the tree.</p>
<p>To that end, the string representation we produce isn&#x27;t going to be Lox syntax.
Instead, it will look a lot like, well, Lisp. Each expression is explicitly
parenthesized, and all of its subexpressions and tokens are contained in that.</p>
<p>Given a syntax tree like:</p>
<img decoding="async" loading="lazy" src="image/representing-code/expression.png" alt="An example syntax tree." class="img_ev3q">
<p>It produces:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(* (- 123) (group 45.67))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Not exactly &quot;pretty&quot;, but it does show the nesting and grouping explicitly. To
implement this, we define a new class.</p>
<p>^code ast-printer</p>
<p>As you can see, it implements the visitor interface. That means we need visit
methods for each of the expression types we have so far.</p>
<p>^code visit-methods (2 before, 1 after)</p>
<p>Literal expressions are easy -- they convert the value to a string with a little
check to handle Java&#x27;s <code>null</code> standing in for Lox&#x27;s <code>nil</code>. The other expressions
have subexpressions, so they use this <code>parenthesize()</code> helper method:</p>
<p>^code print-utilities</p>
<p>It takes a name and a list of subexpressions and wraps them all up in
parentheses, yielding a string like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(+ 1 2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that it calls <code>accept()</code> on each subexpression and passes in itself. This
is the <span name="tree">recursive</span> step that lets us print an entire
tree.</p>
<aside name="tree">
<p>This recursion is also why people think the Visitor pattern itself has to do
with trees.</p>
</aside>
<p>We don&#x27;t have a parser yet, so it&#x27;s hard to see this in action. For now, we&#x27;ll
hack together a little <code>main()</code> method that manually instantiates a tree and
prints it.</p>
<p>^code printer-main</p>
<p>If we did everything right, it prints:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(* (- 123) (group 45.67))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can go ahead and delete this method. We won&#x27;t need it. Also, as we add new
syntax tree types, I won&#x27;t bother showing the necessary visit methods for them
in AstPrinter. If you want to (and you want the Java compiler to not yell at
you), go ahead and add them yourself. It will come in handy in the next chapter
when we start parsing Lox code into syntax trees. Or, if you don&#x27;t care to
maintain AstPrinter, feel free to delete it. We won&#x27;t need it again.</p>
<div class="challenges">
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a href="#challenges" class="hash-link" aria-label="Challenges的直接链接" title="Challenges的直接链接">​</a></h2>
<ol>
<li>
<p>Earlier, I said that the <code>|</code>, <code>*</code>, and <code>+</code> forms we added to our grammar
metasyntax were just syntactic sugar. Take this grammar:</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">expr → expr ( &quot;(&quot; ( expr ( &quot;,&quot; expr )* )? &quot;)&quot; | &quot;.&quot; IDENTIFIER )+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     | IDENTIFIER</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     | NUMBER</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Produce a grammar that matches the same language but does not use any of
that notational sugar.</p>
<p><em>Bonus:</em> What kind of expression does this bit of grammar encode?</p>
</li>
<li>
<p>The Visitor pattern lets you emulate the functional style in an
object-oriented language. Devise a complementary pattern for a functional
language. It should let you bundle all of the operations on one type
together and let you define new types easily.</p>
<p>(SML or Haskell would be ideal for this exercise, but Scheme or another Lisp
works as well.)</p>
</li>
<li>
<p>In <a href="https://en.wikipedia.org/wiki/Reverse_Polish_notation" target="_blank" rel="noopener noreferrer">reverse Polish notation</a> (RPN), the operands to an arithmetic
operator are both placed before the operator, so <code>1 + 2</code> becomes <code>1 2 +</code>.
Evaluation proceeds from left to right. Numbers are pushed onto an implicit
stack. An arithmetic operator pops the top two numbers, performs the
operation, and pushes the result. Thus, this:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(1 + 2) * (4 - 3)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>in RPN becomes:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1 2 + 4 3 - *</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Define a visitor class for our syntax tree classes that takes an expression,
converts it to RPN, and returns the resulting string.</p>
</li>
</ol>
</div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/jabberwocky238/jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/representing-code.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Craftinginterpreters/not-translated-yet/parsing-expressions"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">parsing-expressions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Craftinginterpreters/not-translated-yet/resolving-and-binding"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">resolving-and-binding</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#context-free-grammars" class="table-of-contents__link toc-highlight">Context-Free Grammars</a><ul><li><a href="#rules-for-grammars" class="table-of-contents__link toc-highlight">Rules for grammars</a></li><li><a href="#enhancing-our-notation" class="table-of-contents__link toc-highlight">Enhancing our notation</a></li><li><a href="#a-grammar-for-lox-expressions" class="table-of-contents__link toc-highlight">A Grammar for Lox expressions</a></li></ul></li><li><a href="#implementing-syntax-trees" class="table-of-contents__link toc-highlight">Implementing Syntax Trees</a><ul><li><a href="#disoriented-objects" class="table-of-contents__link toc-highlight">Disoriented objects</a></li><li><a href="#metaprogramming-the-trees" class="table-of-contents__link toc-highlight">Metaprogramming the trees</a></li></ul></li><li><a href="#working-with-trees" class="table-of-contents__link toc-highlight">Working with Trees</a><ul><li><a href="#the-expression-problem" class="table-of-contents__link toc-highlight">The expression problem</a></li><li><a href="#the-visitor-pattern" class="table-of-contents__link toc-highlight">The Visitor pattern</a></li><li><a href="#visitors-for-expressions" class="table-of-contents__link toc-highlight">Visitors for expressions</a></li></ul></li><li><a href="#a-not-very-pretty-printer" class="table-of-contents__link toc-highlight">A (Not Very) Pretty Printer</a></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>