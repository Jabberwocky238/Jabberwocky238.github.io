<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Craftinginterpreters/not-translated-yet/global-variables" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">global-variables | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jabberwocky238.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jabberwocky238.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/global-variables"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="global-variables | My Site"><meta data-rh="true" name="description" content="If only there could be an invention that bottled up a memory, like scent. And"><meta data-rh="true" property="og:description" content="If only there could be an invention that bottled up a memory, like scent. And"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/global-variables"><link data-rh="true" rel="alternate" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/global-variables" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/global-variables" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.0d35426a.css">
<script src="/assets/js/runtime~main.0868a236.js" defer="defer"></script>
<script src="/assets/js/main.f1c02528.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jabberwocky238/jabberwocky238.github.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="展开侧边栏分类 &#x27;Tutorial - Basics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="展开侧边栏分类 &#x27;Tutorial - Extras&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/english">English</a><button aria-label="展开侧边栏分类 &#x27;English&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/crafting-interpreter">Crafting-interpreter</a><button aria-label="折叠侧边栏分类 &#x27;Crafting-interpreter&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/category/welcome">Welcome</a><button aria-label="展开侧边栏分类 &#x27;Welcome&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/not-translated-yet">not-translated-yet</a><button aria-label="折叠侧边栏分类 &#x27;not-translated-yet&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-bytecode-virtual-machine">a-bytecode-virtual-machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-tree-walk-interpreter">a-tree-walk-interpreter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/a-virtual-machine">a-virtual-machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/acknowledgements">acknowledgements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/appendix-i">appendix-i</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/appendix-ii">appendix-ii</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/backmatter">backmatter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/calls-and-functions">calls-and-functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/chunks-of-bytecode">chunks-of-bytecode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/classes-and-instances">classes-and-instances</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/classes">classes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/closures">closures</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/compiling-expressions">compiling-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/contents">contents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/control-flow">control-flow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/dedication">dedication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/evaluating-expressions">evaluating-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/functions">functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/garbage-collection">garbage-collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/global-variables">global-variables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/hash-tables">hash-tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/inheritance">inheritance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/jumping-back-and-forth">jumping-back-and-forth</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/local-variables">local-variables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/methods-and-initializers">methods-and-initializers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/optimization">optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/parsing-expressions">parsing-expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/representing-code">representing-code</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/resolving-and-binding">resolving-and-binding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/scanning-on-demand">scanning-on-demand</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/scanning">scanning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/statements-and-state">statements-and-state</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/strings">strings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/superclasses">superclasses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/the-lox-language">the-lox-language</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Craftinginterpreters/not-translated-yet/types-of-values">types-of-values</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/crafting-interpreter"><span itemprop="name">Crafting-interpreter</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/not-translated-yet"><span itemprop="name">not-translated-yet</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">global-variables</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>global-variables</h1></header><blockquote>
<p>If only there could be an invention that bottled up a memory, like scent. And
it never faded, and it never got stale. And then, when one wanted it, the
bottle could be uncorked, and it would be like living the moment all over
again.</p>
<p><cite>Daphne du Maurier, <em>Rebecca</em></cite></p>
</blockquote>
<p>The <a href="/docs/Craftinginterpreters/not-translated-yet/hash-tables.html">previous chapter</a> was a long exploration of one big, deep,
fundamental computer science data structure. Heavy on theory and concept. There
may have been some discussion of big-O notation and algorithms. This chapter has
fewer intellectual pretensions. There are no large ideas to learn. Instead, it&#x27;s
a handful of straightforward engineering tasks. Once we&#x27;ve completed them, our
virtual machine will support variables.</p>
<p>Actually, it will support only <em>global</em> variables. Locals are coming in the
<a href="/docs/Craftinginterpreters/not-translated-yet/local-variables.html">next chapter</a>. In jlox, we managed to cram them both into a single chapter
because we used the same implementation technique for all variables. We built a
chain of environments, one for each scope, all the way up to the top. That was a
simple, clean way to learn how to manage state.</p>
<p>But it&#x27;s also <em>slow</em>. Allocating a new hash table each time you enter a block or
call a function is not the road to a fast VM. Given how much code is concerned
with using variables, if variables go slow, everything goes slow. For clox,
we&#x27;ll improve that by using a much more efficient strategy for <span name="different">local</span> variables, but globals aren&#x27;t as easily optimized.</p>
<aside name="different">
<p>This is a common meta-strategy in sophisticated language implementations. Often,
the same language feature will have multiple implementation techniques, each
tuned for different use patterns. For example, JavaScript VMs often have a
faster representation for objects that are used more like instances of classes
compared to other objects whose set of properties is more freely modified. C and
C++ compilers usually have a variety of ways to compile <code>switch</code> statements
based on the number of cases and how densely packed the case values are.</p>
</aside>
<p>A quick refresher on Lox semantics: Global variables in Lox are &quot;late bound&quot;, or
resolved dynamically. This means you can compile a chunk of code that refers to
a global variable before it&#x27;s defined. As long as the code doesn&#x27;t <em>execute</em>
before the definition happens, everything is fine. In practice, that means you
can refer to later variables inside the body of functions.</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">fun showVariable() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  print global;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">var global = &quot;after&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">showVariable();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Code like this might seem odd, but it&#x27;s handy for defining mutually recursive
functions. It also plays nicer with the REPL. You can write a little function in
one line, then define the variable it uses in the next.</p>
<p>Local variables work differently. Since a local variable&#x27;s declaration <em>always</em>
occurs before it is used, the VM can resolve them at compile time, even in a
simple single-pass compiler. That will let us use a smarter representation for
locals. But that&#x27;s for the next chapter. Right now, let&#x27;s just worry about
globals.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="statements">Statements<a href="#statements" class="hash-link" aria-label="Statements的直接链接" title="Statements的直接链接">​</a></h2>
<p>Variables come into being using variable declarations, which means now is also
the time to add support for statements to our compiler. If you recall, Lox
splits statements into two categories. &quot;Declarations&quot; are those statements that
bind a new name to a value. The other kinds of statements -- control flow,
print, etc. -- are just called &quot;statements&quot;. We disallow declarations directly
inside control flow statements, like this:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (monday) var croissant = &quot;yes&quot;; // Error.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Allowing it would raise confusing questions around the scope of the variable.
So, like other languages, we prohibit it syntactically by having a separate
grammar rule for the subset of statements that <em>are</em> allowed inside a control
flow body.</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">statement      → exprStmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | forStmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | ifStmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | printStmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | returnStmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | whileStmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | block ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then we use a separate rule for the top level of a script and inside a block.</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">declaration    → classDecl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | funDecl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | varDecl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | statement ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>declaration</code> rule contains the statements that declare names, and also
includes <code>statement</code> so that all statement types are allowed. Since <code>block</code>
itself is in <code>statement</code>, you can put declarations <span name="parens">inside</span> a control flow construct by nesting them inside a
block.</p>
<aside name="parens">
<p>Blocks work sort of like parentheses do for expressions. A block lets you put
the &quot;lower-precedence&quot; declaration statements in places where only a
&quot;higher-precedence&quot; non-declaring statement is allowed.</p>
</aside>
<p>In this chapter, we&#x27;ll cover only a couple of statements and one
declaration.</p>
<div class="language-ebnf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ebnf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">statement      → exprStmt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | printStmt ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">declaration    → varDecl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               | statement ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Up to now, our VM considered a &quot;program&quot; to be a single expression since that&#x27;s
all we could parse and compile. In a full Lox implementation, a program is a
sequence of declarations. We&#x27;re ready to support that now.</p>
<p>^code compile (1 before, 1 after)</p>
<p>We keep compiling declarations until we hit the end of the source file. We
compile a single declaration using this:</p>
<p>^code declaration</p>
<p>We&#x27;ll get to variable declarations later in the chapter, so for now, we simply
forward to <code>statement()</code>.</p>
<p>^code statement</p>
<p>Blocks can contain declarations, and control flow statements can contain other
statements. That means these two functions will eventually be recursive. We may
as well write out the forward declarations now.</p>
<p>^code forward-declarations (1 before, 1 after)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="print-statements">Print statements<a href="#print-statements" class="hash-link" aria-label="Print statements的直接链接" title="Print statements的直接链接">​</a></h3>
<p>We have two statement types to support in this chapter. Let&#x27;s start with <code>print</code>
statements, which begin, naturally enough, with a <code>print</code> token. We detect that
using this helper function:</p>
<p>^code match</p>
<p>You may recognize it from jlox. If the current token has the given type, we
consume the token and return <code>true</code>. Otherwise we leave the token alone and
return <code>false</code>. This <span name="turtles">helper</span> function is implemented
in terms of this other helper:</p>
<aside name="turtles">
<p>It&#x27;s helpers all the way down!</p>
</aside>
<p>^code check</p>
<p>The <code>check()</code> function returns <code>true</code> if the current token has the given type.
It seems a little <span name="read">silly</span> to wrap this in a function, but
we&#x27;ll use it more later, and I think short verb-named functions like this make
the parser easier to read.</p>
<aside name="read">
<p>This sounds trivial, but handwritten parsers for non-toy languages get pretty
big. When you have thousands of lines of code, a utility function that turns two
lines into one and makes the result a little more readable easily earns its
keep.</p>
</aside>
<p>If we did match the <code>print</code> token, then we compile the rest of the statement
here:</p>
<p>^code print-statement</p>
<p>A <code>print</code> statement evaluates an expression and prints the result, so we first
parse and compile that expression. The grammar expects a semicolon after that,
so we consume it. Finally, we emit a new instruction to print the result.</p>
<p>^code op-print (1 before, 1 after)</p>
<p>At runtime, we execute this instruction like so:</p>
<p>^code interpret-print (1 before, 1 after)</p>
<p>When the interpreter reaches this instruction, it has already executed the code
for the expression, leaving the result value on top of the stack. Now we simply
pop and print it.</p>
<p>Note that we don&#x27;t push anything else after that. This is a key difference
between expressions and statements in the VM. Every bytecode instruction has a
<span name="effect"><strong>stack effect</strong></span> that describes how the instruction
modifies the stack. For example, <code>OP_ADD</code> pops two values and pushes one,
leaving the stack one element smaller than before.</p>
<aside name="effect">
<p>The stack is one element shorter after an <code>OP_ADD</code>, so its effect is -1:</p>
<img decoding="async" loading="lazy" src="image/global-variables/stack-effect.png" alt="The stack effect of an OP_ADD instruction." class="img_ev3q">
</aside>
<p>You can sum the stack effects of a series of instructions to get their total
effect. When you add the stack effects of the series of instructions compiled
from any complete expression, it will total one. Each expression leaves one
result value on the stack.</p>
<p>The bytecode for an entire statement has a total stack effect of zero. Since a
statement produces no values, it ultimately leaves the stack unchanged, though
it of course uses the stack while it&#x27;s doing its thing. This is important
because when we get to control flow and looping, a program might execute a long
series of statements. If each statement grew or shrank the stack, it might
eventually overflow or underflow.</p>
<p>While we&#x27;re in the interpreter loop, we should delete a bit of code.</p>
<p>^code op-return (1 before, 1 after)</p>
<p>When the VM only compiled and evaluated a single expression, we had some
temporary code in <code>OP_RETURN</code> to output the value. Now that we have statements
and <code>print</code>, we don&#x27;t need that anymore. We&#x27;re one <span name="return">step</span> closer to the complete implementation of clox.</p>
<aside name="return">
<p>We&#x27;re only one step closer, though. We will revisit <code>OP_RETURN</code> again when we
add functions. Right now, it exits the entire interpreter loop.</p>
</aside>
<p>As usual, a new instruction needs support in the disassembler.</p>
<p>^code disassemble-print (1 before, 1 after)</p>
<p>That&#x27;s our <code>print</code> statement. If you want, give it a whirl:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">print 1 + 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">print 3 * 4;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Exciting! OK, maybe not thrilling, but we can build scripts that contain as many
statements as we want now, which feels like progress.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expression-statements">Expression statements<a href="#expression-statements" class="hash-link" aria-label="Expression statements的直接链接" title="Expression statements的直接链接">​</a></h3>
<p>Wait until you see the next statement. If we <em>don&#x27;t</em> see a <code>print</code> keyword, then
we must be looking at an expression statement.</p>
<p>^code parse-expressions-statement (1 before, 1 after)</p>
<p>It&#x27;s parsed like so:</p>
<p>^code expression-statement</p>
<p>An &quot;expression statement&quot; is simply an expression followed by a semicolon.
They&#x27;re how you write an expression in a context where a statement is expected.
Usually, it&#x27;s so that you can call a function or evaluate an assignment for its
side effect, like this:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">brunch = &quot;quiche&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">eat(brunch);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Semantically, an expression statement evaluates the expression and discards the
result. The compiler directly encodes that behavior. It compiles the expression,
and then emits an <code>OP_POP</code> instruction.</p>
<p>^code pop-op (1 before, 1 after)</p>
<p>As the name implies, that instruction pops the top value off the stack and
forgets it.</p>
<p>^code interpret-pop (1 before, 1 after)</p>
<p>We can disassemble it too.</p>
<p>^code disassemble-pop (1 before, 1 after)</p>
<p>Expression statements aren&#x27;t very useful yet since we can&#x27;t create any
expressions that have side effects, but they&#x27;ll be essential when we
<a href="/docs/Craftinginterpreters/not-translated-yet/calls-and-functions.html">add functions later</a>. The <span name="majority">majority</span> of
statements in real-world code in languages like C are expression statements.</p>
<aside name="majority">
<p>By my count, 80 of the 149 statements, in the version of &quot;compiler.c&quot; that we
have at the end of this chapter are expression statements.</p>
</aside>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="error-synchronization">Error synchronization<a href="#error-synchronization" class="hash-link" aria-label="Error synchronization的直接链接" title="Error synchronization的直接链接">​</a></h3>
<p>While we&#x27;re getting this initial work done in the compiler, we can tie off a
loose end we left <a href="/docs/Craftinginterpreters/not-translated-yet/compiling-expressions.html#handling-syntax-errors">several chapters back</a>. Like jlox, clox uses panic
mode error recovery to minimize the number of cascaded compile errors that it
reports. The compiler exits panic mode when it reaches a synchronization point.
For Lox, we chose statement boundaries as that point. Now that we have
statements, we can implement synchronization.</p>
<p>^code call-synchronize (1 before, 1 after)</p>
<p>If we hit a compile error while parsing the previous statement, we enter panic
mode. When that happens, after the statement we start synchronizing.</p>
<p>^code synchronize</p>
<p>We skip tokens indiscriminately until we reach something that looks like a
statement boundary. We recognize the boundary by looking for a preceding token
that can end a statement, like a semicolon. Or we&#x27;ll look for a subsequent token
that begins a statement, usually one of the control flow or declaration
keywords.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="variable-declarations">Variable Declarations<a href="#variable-declarations" class="hash-link" aria-label="Variable Declarations的直接链接" title="Variable Declarations的直接链接">​</a></h2>
<p>Merely being able to <em>print</em> doesn&#x27;t win your language any prizes at the
programming language <span name="fair">fair</span>, so let&#x27;s move on to
something a little more ambitious and get variables going. There are three
operations we need to support:</p>
<aside name="fair">
<p>I can&#x27;t help but imagine a &quot;language fair&quot; like some country 4H thing. Rows of
straw-lined stalls full of baby languages <em>moo</em>ing and <em>baa</em>ing at each other.</p>
</aside>
<ul>
<li>Declaring a new variable using a <code>var</code> statement.</li>
<li>Accessing the value of a variable using an identifier expression.</li>
<li>Storing a new value in an existing variable using an assignment expression.</li>
</ul>
<p>We can&#x27;t do either of the last two until we have some variables, so we start
with declarations.</p>
<p>^code match-var (1 before, 2 after)</p>
<p>The placeholder parsing function we sketched out for the declaration grammar
rule has an actual production now. If we match a <code>var</code> token, we jump here:</p>
<p>^code var-declaration</p>
<p>The keyword is followed by the variable name. That&#x27;s compiled by
<code>parseVariable()</code>, which we&#x27;ll get to in a second. Then we look for an <code>=</code>
followed by an initializer expression. If the user doesn&#x27;t initialize the
variable, the compiler implicitly initializes it to <span name="nil"><code>nil</code></span> by emitting an <code>OP_NIL</code> instruction. Either way, we
expect the statement to be terminated with a semicolon.</p>
<aside name="nil" class="bottom">
<p>Essentially, the compiler desugars a variable declaration like:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">var a;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>into:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">var a = nil;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code it generates for the former is identical to what it produces for the
latter.</p>
</aside>
<p>There are two new functions here for working with variables and identifiers.
Here is the first:</p>
<p>^code parse-variable (2 before)</p>
<p>It requires the next token to be an identifier, which it consumes and sends
here:</p>
<p>^code identifier-constant (2 before)</p>
<p>This function takes the given token and adds its lexeme to the chunk&#x27;s constant
table as a string. It then returns the index of that constant in the constant
table.</p>
<p>Global variables are looked up <em>by name</em> at runtime. That means the VM -- the
bytecode interpreter loop -- needs access to the name. A whole string is too big
to stuff into the bytecode stream as an operand. Instead, we store the string in
the constant table and the instruction then refers to the name by its index in
the table.</p>
<p>This function returns that index all the way to <code>varDeclaration()</code> which later
hands it over to here:</p>
<p>^code define-variable</p>
<p><span name="helper">This</span> outputs the bytecode instruction that defines
the new variable and stores its initial value. The index of the variable&#x27;s name
in the constant table is the instruction&#x27;s operand. As usual in a stack-based
VM, we emit this instruction last. At runtime, we execute the code for the
variable&#x27;s initializer first. That leaves the value on the stack. Then this
instruction takes that value and stores it away for later.</p>
<aside name="helper">
<p>I know some of these functions seem pretty pointless right now. But we&#x27;ll get
more mileage out of them as we add more language features for working with
names. Function and class declarations both declare new variables, and variable
and assignment expressions access them.</p>
</aside>
<p>Over in the runtime, we begin with this new instruction:</p>
<p>^code define-global-op (1 before, 1 after)</p>
<p>Thanks to our handy-dandy hash table, the implementation isn&#x27;t too hard.</p>
<p>^code interpret-define-global (1 before, 1 after)</p>
<p>We get the name of the variable from the constant table. Then we <span name="pop">take</span> the value from the top of the stack and store it in a
hash table with that name as the key.</p>
<aside name="pop">
<p>Note that we don&#x27;t <em>pop</em> the value until <em>after</em> we add it to the hash table.
That ensures the VM can still find the value if a garbage collection is
triggered right in the middle of adding it to the hash table. That&#x27;s a distinct
possibility since the hash table requires dynamic allocation when it resizes.</p>
</aside>
<p>This code doesn&#x27;t check to see if the key is already in the table. Lox is pretty
lax with global variables and lets you redefine them without error. That&#x27;s
useful in a REPL session, so the VM supports that by simply overwriting the
value if the key happens to already be in the hash table.</p>
<p>There&#x27;s another little helper macro:</p>
<p>^code read-string (1 before, 1 after)</p>
<p>It reads a one-byte operand from the bytecode chunk. It treats that as an index
into the chunk&#x27;s constant table and returns the string at that index. It doesn&#x27;t
check that the value <em>is</em> a string -- it just indiscriminately casts it. That&#x27;s
safe because the compiler never emits an instruction that refers to a non-string
constant.</p>
<p>Because we care about lexical hygiene, we also undefine this macro at the end of
the interpret function.</p>
<p>^code undef-read-string (1 before, 1 after)</p>
<p>I keep saying &quot;the hash table&quot;, but we don&#x27;t actually have one yet. We need a
place to store these globals. Since we want them to persist as long as clox is
running, we store them right in the VM.</p>
<p>^code vm-globals (1 before, 1 after)</p>
<p>As we did with the string table, we need to initialize the hash table to a valid
state when the VM boots up.</p>
<p>^code init-globals (1 before, 1 after)</p>
<p>And we <span name="tear">tear</span> it down when we exit.</p>
<aside name="tear">
<p>The process will free everything on exit, but it feels undignified to require
the operating system to clean up our mess.</p>
</aside>
<p>^code free-globals (1 before, 1 after)</p>
<p>As usual, we want to be able to disassemble the new instruction too.</p>
<p>^code disassemble-define-global (1 before, 1 after)</p>
<p>And with that, we can define global variables. Not that users can <em>tell</em> that
they&#x27;ve done so, because they can&#x27;t actually <em>use</em> them. So let&#x27;s fix that next.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reading-variables">Reading Variables<a href="#reading-variables" class="hash-link" aria-label="Reading Variables的直接链接" title="Reading Variables的直接链接">​</a></h2>
<p>As in every programming language ever, we access a variable&#x27;s value using its
name. We hook up identifier tokens to the expression parser here:</p>
<p>^code table-identifier (1 before, 1 after)</p>
<p>That calls this new parser function:</p>
<p>^code variable-without-assign</p>
<p>Like with declarations, there are a couple of tiny helper functions that seem
pointless now but will become more useful in later chapters. I promise.</p>
<p>^code read-named-variable</p>
<p>This calls the same <code>identifierConstant()</code> function from before to take the
given identifier token and add its lexeme to the chunk&#x27;s constant table as a
string. All that remains is to emit an instruction that loads the global
variable with that name. Here&#x27;s the instruction:</p>
<p>^code get-global-op (1 before, 1 after)</p>
<p>Over in the interpreter, the implementation mirrors <code>OP_DEFINE_GLOBAL</code>.</p>
<p>^code interpret-get-global (1 before, 1 after)</p>
<p>We pull the constant table index from the instruction&#x27;s operand and get the
variable name. Then we use that as a key to look up the variable&#x27;s value in the
globals hash table.</p>
<p>If the key isn&#x27;t present in the hash table, it means that global variable has
never been defined. That&#x27;s a runtime error in Lox, so we report it and exit the
interpreter loop if that happens. Otherwise, we take the value and push it
onto the stack.</p>
<p>^code disassemble-get-global (1 before, 1 after)</p>
<p>A little bit of disassembling, and we&#x27;re done. Our interpreter is now able to
run code like this:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">var beverage = &quot;cafe au lait&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">var breakfast = &quot;beignets with &quot; + beverage;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">print breakfast;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There&#x27;s only one operation left.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="assignment">Assignment<a href="#assignment" class="hash-link" aria-label="Assignment的直接链接" title="Assignment的直  接链接">​</a></h2>
<p>Throughout this book, I&#x27;ve tried to keep you on a fairly safe and easy path. I
don&#x27;t avoid hard <em>problems</em>, but I try to not make the <em>solutions</em> more complex
than they need to be. Alas, other design choices in our <span name="jlox">bytecode</span> compiler make assignment annoying to implement.</p>
<aside name="jlox">
<p>If you recall, assignment was pretty easy in jlox.</p>
</aside>
<p>Our bytecode VM uses a single-pass compiler. It parses and generates bytecode
on the fly without any intermediate AST. As soon as it recognizes a piece of
syntax, it emits code for it. Assignment doesn&#x27;t naturally fit that. Consider:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">menu.brunch(sunday).beverage = &quot;mimosa&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this code, the parser doesn&#x27;t realize <code>menu.brunch(sunday).beverage</code> is the
target of an assignment and not a normal expression until it reaches <code>=</code>, many
tokens after the first <code>menu</code>. By then, the compiler has already emitted
bytecode for the whole thing.</p>
<p>The problem is not as dire as it might seem, though. Look at how the parser sees that example:</p>
<img decoding="async" loading="lazy" src="image/global-variables/setter.png" alt="The &#x27;menu.brunch(sunday).beverage = &quot;mimosa&quot;&#x27; statement, showing that &#x27;menu.brunch(sunday)&#x27; is an expression." class="img_ev3q">
<p>Even though the <code>.beverage</code> part must not be compiled as a get expression,
everything to the left of the <code>.</code> is an expression, with the normal expression
semantics. The <code>menu.brunch(sunday)</code> part can be compiled and executed as usual.</p>
<p>Fortunately for us, the only semantic differences on the left side of an
assignment appear at the very right-most end of the tokens, immediately
preceding the <code>=</code>. Even though the receiver of a setter may be an arbitrarily
long expression, the part whose behavior differs from a get expression is only
the trailing identifier, which is right before the <code>=</code>. We don&#x27;t need much
lookahead to realize <code>beverage</code> should be compiled as a set expression and not a
getter.</p>
<p>Variables are even easier since they are just a single bare identifier before an
<code>=</code>. The idea then is that right <em>before</em> compiling an expression that can also
be used as an assignment target, we look for a subsequent <code>=</code> token. If we see
one, we compile it as an assignment or setter instead of a variable access or
getter.</p>
<p>We don&#x27;t have setters to worry about yet, so all we need to handle are variables.</p>
<p>^code named-variable (1 before, 1 after)</p>
<p>In the parse function for identifier expressions, we look for an equals sign
after the identifier. If we find one, instead of emitting code for a variable
access, we compile the assigned value and then emit an assignment instruction.</p>
<p>That&#x27;s the last instruction we need to add in this chapter.</p>
<p>^code set-global-op (1 before, 1 after)</p>
<p>As you&#x27;d expect, its runtime behavior is similar to defining a new variable.</p>
<p>^code interpret-set-global (1 before, 1 after)</p>
<p>The main difference is what happens when the key doesn&#x27;t already exist in the
globals hash table. If the variable hasn&#x27;t been defined yet, it&#x27;s a runtime
error to try to assign to it. Lox <a href="/docs/Craftinginterpreters/not-translated-yet/statements-and-state.html#design-note">doesn&#x27;t do implicit variable
declaration</a>.</p>
<aside name="delete">
<p>The call to <code>tableSet()</code> stores the value in the global variable table even if
the variable wasn&#x27;t previously defined. That fact is visible in a REPL session,
since it keeps running even after the runtime error is reported. So we also take
care to delete that zombie value from the table.</p>
</aside>
<p>The other difference is that setting a variable doesn&#x27;t pop the value off the
stack. Remember, assignment is an expression, so it needs to leave that value
there in case the assignment is nested inside some larger expression.</p>
<p>Add a dash of disassembly:</p>
<p>^code disassemble-set-global (2 before, 1 after)</p>
<p>So we&#x27;re done, right? Well... not quite. We&#x27;ve made a mistake! Take a gander at:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">a * b = c + d;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>According to Lox&#x27;s grammar, <code>=</code> has the lowest precedence, so this should be
parsed roughly like:</p>
<img decoding="async" loading="lazy" src="image/global-variables/ast-good.png" alt="The expected parse, like &#x27;(a * b) = (c + d)&#x27;." class="img_ev3q">
<p>Obviously, <code>a * b</code> isn&#x27;t a <span name="do">valid</span> assignment target, so
this should be a syntax error. But here&#x27;s what our parser does:</p>
<aside name="do">
<p>Wouldn&#x27;t it be wild if <code>a * b</code> <em>was</em> a valid assignment target, though? You
could imagine some algebra-like language that tried to divide the assigned value
up in some reasonable way and distribute it to <code>a</code> and <code>b</code>... that&#x27;s probably
a terrible idea.</p>
</aside>
<ol>
<li>First, <code>parsePrecedence()</code> parses <code>a</code> using the <code>variable()</code> prefix parser.</li>
<li>After that, it enters the infix parsing loop.</li>
<li>It reaches the <code>*</code> and calls <code>binary()</code>.</li>
<li>That recursively calls <code>parsePrecedence()</code> to parse the right-hand operand.</li>
<li>That calls <code>variable()</code> again for parsing <code>b</code>.</li>
<li>Inside that call to <code>variable()</code>, it looks for a trailing <code>=</code>. It sees one
and thus parses the rest of the line as an assignment.</li>
</ol>
<p>In other words, the parser sees the above code like:</p>
<img decoding="async" loading="lazy" src="image/global-variables/ast-bad.png" alt="The actual parse, like &#x27;a * (b = c + d)&#x27;." class="img_ev3q">
<p>We&#x27;ve messed up the precedence handling because <code>variable()</code> doesn&#x27;t take into
account the precedence of the surrounding expression that contains the variable.
If the variable happens to be the right-hand side of an infix operator, or the
operand of a unary operator, then that containing expression is too high
precedence to permit the <code>=</code>.</p>
<p>To fix this, <code>variable()</code> should look for and consume the <code>=</code> only if it&#x27;s in
the context of a low-precedence expression. The code that knows the current
precedence is, logically enough, <code>parsePrecedence()</code>. The <code>variable()</code> function
doesn&#x27;t need to know the actual level. It just cares that the precedence is low
enough to allow assignment, so we pass that fact in as a Boolean.</p>
<p>^code prefix-rule (4 before, 2 after)</p>
<p>Since assignment is the lowest-precedence expression, the only time we allow an
assignment is when parsing an assignment expression or top-level expression like
in an expression statement. That flag makes its way to the parser function here:</p>
<p>^code variable</p>
<p>Which passes it through a new parameter:</p>
<p>^code named-variable-signature (1 after)</p>
<p>And then finally uses it here:</p>
<p>^code named-variable-can-assign (2 before, 1 after)</p>
<p>That&#x27;s a lot of plumbing to get literally one bit of data to the right place in
the compiler, but arrived it has. If the variable is nested inside some
expression with higher precedence, <code>canAssign</code> will be <code>false</code> and this will
ignore the <code>=</code> even if there is one there. Then <code>namedVariable()</code> returns, and
execution eventually makes its way back to <code>parsePrecedence()</code>.</p>
<p>Then what? What does the compiler do with our broken example from before? Right
now, <code>variable()</code> won&#x27;t consume the <code>=</code>, so that will be the current token. The
compiler returns back to <code>parsePrecedence()</code> from the <code>variable()</code> prefix parser
and then tries to enter the infix parsing loop. There is no parsing function
associated with <code>=</code>, so it skips that loop.</p>
<p>Then <code>parsePrecedence()</code> silently returns back to the caller. That also isn&#x27;t
right. If the <code>=</code> doesn&#x27;t get consumed as part of the expression, nothing else
is going to consume it. It&#x27;s an error and we should report it.</p>
<p>^code invalid-assign (2 before, 1 after)</p>
<p>With that, the previous bad program correctly gets an error at compile time. OK,
<em>now</em> are we done? Still not quite. See, we&#x27;re passing an argument to one of the
parse functions. But those functions are stored in a table of function pointers,
so all of the parse functions need to have the same type. Even though most parse
functions don&#x27;t support being used as an assignment target -- setters are the
<span name="index">only</span> other one -- our friendly C compiler requires
them <em>all</em> to accept the parameter.</p>
<aside name="index">
<p>If Lox had arrays and subscript operators like <code>array[index]</code> then an infix <code>[</code>
would also allow assignment to support <code>array[index] = value</code>.</p>
</aside>
<p>So we&#x27;re going to finish off this chapter with some grunt work. First, let&#x27;s go
ahead and pass the flag to the infix parse functions.</p>
<p>^code infix-rule (1 before, 1 after)</p>
<p>We&#x27;ll need that for setters eventually. Then we&#x27;ll fix the typedef for the
function type.</p>
<p>^code parse-fn-type (2 before, 2 after)</p>
<p>And some completely tedious code to accept this parameter in all of our existing
parse functions. Here:</p>
<p>^code binary (1 after)</p>
<p>And here:</p>
<p>^code parse-literal (1 after)</p>
<p>And here:</p>
<p>^code grouping (1 after)</p>
<p>And here:</p>
<p>^code number (1 after)</p>
<p>And here too:</p>
<p>^code string (1 after)</p>
<p>And, finally:</p>
<p>^code unary (1 after)</p>
<p>Phew! We&#x27;re back to a C program we can compile. Fire it up and now you can run
this:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">var breakfast = &quot;beignets&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">var beverage = &quot;cafe au lait&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">breakfast = &quot;beignets with &quot; + beverage;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">print breakfast;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It&#x27;s starting to look like real code for an actual language!</p>
<div class="challenges">
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a href="#challenges" class="hash-link" aria-label="Challenges的直接链接" title="Challenges的直接链接">​</a></h2>
<ol>
<li>
<p>The compiler adds a global variable&#x27;s name to the constant table as a string
every time an identifier is encountered. It creates a new constant each
time, even if that variable name is already in a previous slot in the
constant table. That&#x27;s wasteful in cases where the same variable is
referenced multiple times by the same function. That, in turn, increases the
odds of filling up the constant table and running out of slots since we
allow only 256 constants in a single chunk.</p>
<p>Optimize this. How does your optimization affect the performance of the
compiler compared to the runtime? Is this the right trade-off?</p>
</li>
<li>
<p>Looking up a global variable by name in a hash table each time it is used
is pretty slow, even with a good hash table. Can you come up with a more
efficient way to store and access global variables without changing the
semantics?</p>
</li>
<li>
<p>When running in the REPL, a user might write a function that references an
unknown global variable. Then, in the next line, they declare the variable.
Lox should handle this gracefully by not reporting an &quot;unknown variable&quot;
compile error when the function is first defined.</p>
<p>But when a user runs a Lox <em>script</em>, the compiler has access to the full
text of the entire program before any code is run. Consider this program:</p>
<div class="language-lox codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lox codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">fun useVar() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  print oops;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">var ooops = &quot;too many o&#x27;s!&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, we can tell statically that <code>oops</code> will not be defined because there
is <em>no</em> declaration of that global anywhere in the program. Note that
<code>useVar()</code> is never called either, so even though the variable isn&#x27;t
defined, no runtime error will occur because it&#x27;s never used either.</p>
<p>We could report mistakes like this as compile errors, at least when running
from a script. Do you think we should? Justify your answer. What do other
scripting languages you know do?</p>
</li>
</ol>
</div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/jabberwocky238/jabberwocky238.github.io/docs/Craftinginterpreters/not-translated-yet/global-variables.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Craftinginterpreters/not-translated-yet/garbage-collection"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">garbage-collection</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Craftinginterpreters/not-translated-yet/hash-tables"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">hash-tables</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#statements" class="table-of-contents__link toc-highlight">Statements</a><ul><li><a href="#print-statements" class="table-of-contents__link toc-highlight">Print statements</a></li><li><a href="#expression-statements" class="table-of-contents__link toc-highlight">Expression statements</a></li><li><a href="#error-synchronization" class="table-of-contents__link toc-highlight">Error synchronization</a></li></ul></li><li><a href="#variable-declarations" class="table-of-contents__link toc-highlight">Variable Declarations</a></li><li><a href="#reading-variables" class="table-of-contents__link toc-highlight">Reading Variables</a></li><li><a href="#assignment" class="table-of-contents__link toc-highlight">Assignment</a></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>